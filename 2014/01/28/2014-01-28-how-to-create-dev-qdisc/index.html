<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>how to create dev qdisc | Kernel Study Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="SummaryPart 1: Register multi queue net device.In this part, only the framework is prepared for qdisc,and the noop_qdisc is set as default. prepare netdev_queues.for example: intel igb hardware has 8">
<meta property="og:type" content="article">
<meta property="og:title" content="how to create dev qdisc">
<meta property="og:url" content="https://martinbj2008.github.io/2014/01/28/2014-01-28-how-to-create-dev-qdisc/index.html">
<meta property="og:site_name" content="Kernel Study Notes">
<meta property="og:description" content="SummaryPart 1: Register multi queue net device.In this part, only the framework is prepared for qdisc,and the noop_qdisc is set as default. prepare netdev_queues.for example: intel igb hardware has 8">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.lucidchart.com/publicSegments/view/52f496a8-5c18-4c12-9d2e-62830a0093bd/image.png">
<meta property="article:published_time" content="2014-01-28T13:47:00.000Z">
<meta property="article:modified_time" content="2025-05-28T12:13:09.562Z">
<meta property="article:author" content="Martinbj2008">
<meta property="article:tag" content="netdev">
<meta property="article:tag" content="IPv4">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.lucidchart.com/publicSegments/view/52f496a8-5c18-4c12-9d2e-62830a0093bd/image.png">
  
    <link rel="alternate" href="/atom.xml" title="Kernel Study Notes" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Kernel Study Notes</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://martinbj2008.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-2014-01-28-how-to-create-dev-qdisc" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2014/01/28/2014-01-28-how-to-create-dev-qdisc/" class="article-date">
  <time class="dt-published" datetime="2014-01-28T13:47:00.000Z" itemprop="datePublished">2014-01-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/netdev/">netdev</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      how to create dev qdisc
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><h3 id="Part-1-Register-multi-queue-net-device"><a href="#Part-1-Register-multi-queue-net-device" class="headerlink" title="Part 1: Register multi queue net device."></a>Part 1: Register multi queue net device.</h3><p>In this part, only the framework is prepared for qdisc,<br>and the <code>noop_qdisc</code> is set as default.</p>
<h4 id="prepare-netdev-queues"><a href="#prepare-netdev-queues" class="headerlink" title="prepare netdev_queues."></a>prepare <code>netdev_queue</code>s.</h4><p>for example: intel igb hardware has 8 hardware tx queue,<br>and nic driver create 8 corresponding <code>struct netdev_queue</code><br>in the <code>_tx</code> of <code>struct net_device</code>.</p>
<h4 id="prepare-mq-qdisc"><a href="#prepare-mq-qdisc" class="headerlink" title="prepare mq_qdisc"></a>prepare <code>mq_qdisc</code></h4><p>The <code>mq_qdisc</code> is attached to the corresponding device.<br>In <code>mq_qdisc</code> private field, a default qdisc will be<br>create for <strong>each</strong> NIC’s hardware queue.<br>This is done in <code>mq_init</code>.<br>The default qdisc is <code>pfifo_fast_ops</code>.</p>
<h4 id="attach-mq-qdisc-to-netdev-queue"><a href="#attach-mq-qdisc-to-netdev-queue" class="headerlink" title="attach mq_qdisc to netdev_queue."></a>attach <code>mq_qdisc</code> to <code>netdev_queue</code>.</h4><p>In <code>mq_attach</code>, these qdiscs are attatched to corresponding<br><code>struct netdev_queue</code>.</p>
<h3 id="Part-2-Active-a-net-device-with-right-qdiscs"><a href="#Part-2-Active-a-net-device-with-right-qdiscs" class="headerlink" title="Part 2: Active a net device with right qdiscs"></a>Part 2: Active a net device with right qdiscs</h3><p>Here only trace with the case <code>mq_qdisc</code>.<br>When dev is up, <code>dev_open</code> is called, which will call <code>dev_activate</code>.</p>
<span id="more"></span>
<h4 id="2-1"><a href="#2-1" class="headerlink" title="2.1"></a>2.1</h4><p>A qdisc with <code>mq_qdisc_ops</code> is alloced and assigned to <code>dev-&gt;qdisc</code>,<br>The <code>mq qdisc</code> is not a simple qdisc, which includes sub-qdisc in its<br>private fields. Each sub-qdisc is a default qdisc(pfif0).</p>
<!-- ![mq qdisc](/images/mq/mq.blankflowchar.jpeg) -->
<p><img src="https://www.lucidchart.com/publicSegments/view/52f496a8-5c18-4c12-9d2e-62830a0093bd/image.png" alt="mq qdisc"></p>
<h4 id="2-2"><a href="#2-2" class="headerlink" title="2.2"></a>2.2</h4><p>when <code>attach</code> a qdisc to a device by <code>qdisc-&gt;attach</code>(which equal <code>mq_attach</code>),<br>in <code>mq_attach</code>, each qdisc alloc in 2.1, will be assigned to a<br>netdevice queue(which is alloced in part1).</p>
<p>by now, each netdevice queue has a qdisc, but the qdisc is assigned to<br><code>qdisc_sleeping</code> of <code>netdev_queue</code>.</p>
<p>at last, <code>dev_activate</code> call <code>transition_one_qdisc</code> for each tx queue,<br>to set <code>netdev_queue-&gt;qdisc</code> with <code>netdev_queue-&gt;qdisc_sleeping</code>.</p>
<p><code>attach_default_qdiscs</code> will be called twice time,<br>one is called to create with <code>mq_qdisc_ops</code>,<br>one is called to create with <code>default_qdisc_ops</code>,</p>
<h4 id="Data-Structure"><a href="#Data-Structure" class="headerlink" title="Data Structure"></a>Data Structure</h4><h5 id="struct-net-device-and-netdev-queue"><a href="#struct-net-device-and-netdev-queue" class="headerlink" title="struct net_device and netdev_queue"></a><code>struct net_device</code> and <code>netdev_queue</code></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> &#123;</span></span><br><span class="line">...</span><br><span class="line"><span class="number">1350</span>         <span class="class"><span class="keyword">struct</span> <span class="title">netdev_queue</span>     *_<span class="title">tx</span> ____<span class="title">cacheline_aligned_in_smp</span>;</span></span><br><span class="line"><span class="number">1351</span></span><br><span class="line"><span class="number">1352</span>         <span class="comment">/* Number of TX queues allocated at alloc_netdev_mq() time  */</span></span><br><span class="line"><span class="number">1353</span>         <span class="type">unsigned</span> <span class="type">int</span>            num_tx_queues;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">544</span> <span class="class"><span class="keyword">struct</span> <span class="title">netdev_queue</span> &#123;</span></span><br><span class="line"> ...</span><br><span class="line"> <span class="number">548</span>         <span class="class"><span class="keyword">struct</span> <span class="title">net_device</span>       *<span class="title">dev</span>;</span></span><br><span class="line"> <span class="number">549</span>         <span class="class"><span class="keyword">struct</span> <span class="title">Qdisc</span>            *<span class="title">qdisc</span>;</span></span><br><span class="line"> <span class="number">550</span>         <span class="class"><span class="keyword">struct</span> <span class="title">Qdisc</span>            *<span class="title">qdisc_sleeping</span>;</span></span><br><span class="line">...</span><br><span class="line"> <span class="number">560</span>         <span class="type">spinlock_t</span>              _xmit_lock ____cacheline_aligned_in_smp;</span><br><span class="line">...</span><br><span class="line"> <span class="number">573</span>         <span class="type">unsigned</span> <span class="type">long</span>           state;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span> <span class="class"><span class="keyword">struct</span> <span class="title">mq_sched</span> &#123;</span></span><br><span class="line"><span class="number">22</span>         <span class="class"><span class="keyword">struct</span> <span class="title">Qdisc</span>            **<span class="title">qdiscs</span>;</span></span><br><span class="line"><span class="number">23</span> &#125;;</span><br></pre></td></tr></table></figure>

<h4 id="Call-trace"><a href="#Call-trace" class="headerlink" title="Call trace."></a>Call trace.</h4><h5 id="Part-1"><a href="#Part-1" class="headerlink" title="Part 1"></a>Part 1</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; igb_probe</span><br><span class="line">&gt; &gt; alloc_etherdev_mq</span><br><span class="line">&gt; &gt; &gt; alloc_etherdev_mqs</span><br><span class="line">&gt; &gt; &gt; &gt; alloc_netdev_mqs</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; ether_setup</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; netif_alloc_netdev_queues</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; &gt; netdev_for_each_tx_queue(dev, netdev_init_one_queue, <span class="literal">NULL</span>);</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; &gt; &gt; netdev_init_one_queue</span><br><span class="line">&gt; &gt; register_netdev</span><br><span class="line">&gt; &gt; &gt; register_netdevice</span><br><span class="line">&gt; &gt; &gt; &gt; dev_init_scheduler</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; netdev_for_each_tx_queue(dev, dev_init_scheduler_queue, &amp;noop_qdisc);</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; &gt; dev_init_scheduler_queue</span><br></pre></td></tr></table></figure>

<p>NOTE:<br>if disable RPS(google patch), there is no soft queue to receive packet.<br>because there is <code>igb_ring</code> in the driver.</p>
<h6 id="Part-2"><a href="#Part-2" class="headerlink" title="Part 2"></a>Part 2</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; dev_open</span><br><span class="line">&gt; &gt; __dev_open</span><br><span class="line">&gt; &gt; &gt; dev_activate</span><br><span class="line">&gt; &gt; &gt; &gt; attach_default_qdiscs(dev);</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; qdisc_create_dflt(txq, &amp;mq_qdisc_ops, TC_H_ROOT);</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; &gt; qdisc_alloc</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; &gt; ops-&gt;init(equal: mq_init)</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; &gt; &gt; <span class="keyword">for</span> (ntx = <span class="number">0</span>; ntx &lt; dev-&gt;num_tx_queues; ntx++) &#123;</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; qdisc_create_dflt(dev_queue, default_qdisc_ops ...</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; qdisc_alloc</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; ops-&gt;init</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; qdisc-&gt;ops-&gt;attach</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; dev_graft_qdisc</span><br><span class="line">&gt; &gt; &gt; &gt; netdev_for_each_tx_queue(dev, transition_one_qdisc, &amp;need_watchdog); </span><br><span class="line">&gt; &gt; &gt; &gt; &gt; transition_one_qdisc</span><br></pre></td></tr></table></figure>

<h3 id="Functions-in-Part-1"><a href="#Functions-in-Part-1" class="headerlink" title="Functions in Part 1."></a>Functions in Part 1.</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2016</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">igb_probe</span><span class="params">(<span class="keyword">struct</span> pci_dev *pdev, <span class="type">const</span> <span class="keyword">struct</span> pci_device_id *ent)</span></span><br><span class="line">2017 &#123;</span><br><span class="line">...</span><br><span class="line"><span class="number">2067</span>         netdev = alloc_etherdev_mq(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> igb_adapter),</span><br><span class="line"><span class="number">2068</span>                                    IGB_MAX_TX_QUEUES);</span><br><span class="line"><span class="number">2069</span>         <span class="keyword">if</span> (!netdev)</span><br><span class="line"><span class="number">2070</span>                 <span class="keyword">goto</span> err_alloc_etherdev;</span><br><span class="line">...</span><br><span class="line"><span class="number">2317</span>         <span class="built_in">strcpy</span>(netdev-&gt;name, <span class="string">&quot;eth%d&quot;</span>);</span><br><span class="line"><span class="number">2318</span>         err = register_netdev(netdev);</span><br><span class="line"><span class="number">2319</span>         <span class="keyword">if</span> (err)</span><br><span class="line"><span class="number">2320</span>                 <span class="keyword">goto</span> err_register;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">51</span> <span class="meta">#<span class="keyword">define</span> alloc_etherdev_mq(sizeof_priv, count) alloc_etherdev_mqs(sizeof_priv, count, count)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">372</span> <span class="comment">/**</span></span><br><span class="line"><span class="comment">373  * alloc_etherdev_mqs - Allocates and sets up an Ethernet device</span></span><br><span class="line"><span class="comment">374  * @sizeof_priv: Size of additional driver-private structure to be allocated</span></span><br><span class="line"><span class="comment">375  *      for this Ethernet device</span></span><br><span class="line"><span class="comment">376  * @txqs: The number of TX queues this device has.</span></span><br><span class="line"><span class="comment">377  * @rxqs: The number of RX queues this device has.</span></span><br><span class="line"><span class="comment">378  *</span></span><br><span class="line"><span class="comment">379  * Fill in the fields of the device structure with Ethernet-generic</span></span><br><span class="line"><span class="comment">380  * values. Basically does everything except registering the device.</span></span><br><span class="line"><span class="comment">381  *</span></span><br><span class="line"><span class="comment">382  * Constructs a new net device, complete with a private data area of</span></span><br><span class="line"><span class="comment">383  * size (sizeof_priv).  A 32-byte (not bit) alignment is enforced for</span></span><br><span class="line"><span class="comment">384  * this private data area.</span></span><br><span class="line"><span class="comment">385  */</span></span><br><span class="line"><span class="number">386</span></span><br><span class="line"><span class="number">387</span> <span class="keyword">struct</span> net_device *<span class="title function_">alloc_etherdev_mqs</span><span class="params">(<span class="type">int</span> sizeof_priv, <span class="type">unsigned</span> <span class="type">int</span> txqs,</span></span><br><span class="line"><span class="params"><span class="number">388</span>                                       <span class="type">unsigned</span> <span class="type">int</span> rxqs)</span></span><br><span class="line">389 &#123;</span><br><span class="line"><span class="number">390</span>         <span class="keyword">return</span> alloc_netdev_mqs(sizeof_priv, <span class="string">&quot;eth%d&quot;</span>, ether_setup, txqs, rxqs);</span><br><span class="line"><span class="number">391</span> &#125;</span><br><span class="line"><span class="number">392</span> EXPORT_SYMBOL(alloc_etherdev_mqs);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">6223</span> <span class="comment">/**</span></span><br><span class="line"><span class="comment">6224  *      alloc_netdev_mqs - allocate network device</span></span><br><span class="line"><span class="comment">6225  *      @sizeof_priv:   size of private data to allocate space for</span></span><br><span class="line"><span class="comment">6226  *      @name:          device name format string</span></span><br><span class="line"><span class="comment">6227  *      @setup:         callback to initialize device</span></span><br><span class="line"><span class="comment">6228  *      @txqs:          the number of TX subqueues to allocate</span></span><br><span class="line"><span class="comment">6229  *      @rxqs:          the number of RX subqueues to allocate</span></span><br><span class="line"><span class="comment">6230  *</span></span><br><span class="line"><span class="comment">6231  *      Allocates a struct net_device with private data area for driver use</span></span><br><span class="line"><span class="comment">6232  *      and performs basic initialization.  Also allocates subquue structs</span></span><br><span class="line"><span class="comment">6233  *      for each queue on the device.</span></span><br><span class="line"><span class="comment">6234  */</span></span><br><span class="line"><span class="number">6235</span> <span class="keyword">struct</span> net_device *<span class="title function_">alloc_netdev_mqs</span><span class="params">(<span class="type">int</span> sizeof_priv, <span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params"><span class="number">6236</span>                 <span class="type">void</span> (*setup)(<span class="keyword">struct</span> net_device *),</span></span><br><span class="line"><span class="params"><span class="number">6237</span>                 <span class="type">unsigned</span> <span class="type">int</span> txqs, <span class="type">unsigned</span> <span class="type">int</span> rxqs)</span></span><br><span class="line">6238 &#123;</span><br><span class="line"><span class="number">6239</span>         <span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">dev</span>;</span></span><br><span class="line"><span class="number">6240</span>         <span class="type">size_t</span> alloc_size;</span><br><span class="line"><span class="number">6241</span>         <span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">p</span>;</span></span><br><span class="line"><span class="number">6242</span></span><br><span class="line"><span class="number">6243</span>         BUG_ON(<span class="built_in">strlen</span>(name) &gt;= <span class="keyword">sizeof</span>(dev-&gt;name));</span><br><span class="line"><span class="number">6244</span></span><br><span class="line"><span class="number">6245</span>         <span class="keyword">if</span> (txqs &lt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="number">6246</span>                 pr_err(<span class="string">&quot;alloc_netdev: Unable to allocate device with zero queues\n&quot;</span>);</span><br><span class="line"><span class="number">6247</span>                 <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">6248</span>         &#125;</span><br><span class="line"><span class="number">6249</span></span><br><span class="line"><span class="number">6250</span> <span class="meta">#<span class="keyword">ifdef</span> CONFIG_RPS</span></span><br><span class="line"><span class="number">6251</span>         <span class="keyword">if</span> (rxqs &lt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="number">6252</span>                 pr_err(<span class="string">&quot;alloc_netdev: Unable to allocate device with zero RX queues\n&quot;</span>);</span><br><span class="line"><span class="number">6253</span>                 <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">6254</span>         &#125;</span><br><span class="line"><span class="number">6255</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">6256</span></span><br><span class="line"><span class="number">6257</span>         alloc_size = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> net_device);</span><br><span class="line"><span class="number">6258</span>         <span class="keyword">if</span> (sizeof_priv) &#123;</span><br><span class="line"><span class="number">6259</span>                 <span class="comment">/* ensure 32-byte alignment of private area */</span></span><br><span class="line"><span class="number">6260</span>                 alloc_size = ALIGN(alloc_size, NETDEV_ALIGN);</span><br><span class="line"><span class="number">6261</span>                 alloc_size += sizeof_priv;</span><br><span class="line"><span class="number">6262</span>         &#125;</span><br><span class="line"><span class="number">6263</span>         <span class="comment">/* ensure 32-byte alignment of whole construct */</span></span><br><span class="line"><span class="number">6264</span>         alloc_size += NETDEV_ALIGN - <span class="number">1</span>;</span><br><span class="line"><span class="number">6265</span></span><br><span class="line"><span class="number">6266</span>         p = kzalloc(alloc_size, GFP_KERNEL | __GFP_NOWARN | __GFP_REPEAT);</span><br><span class="line"><span class="number">6267</span>         <span class="keyword">if</span> (!p)</span><br><span class="line"><span class="number">6268</span>                 p = vzalloc(alloc_size);</span><br><span class="line"><span class="number">6269</span>         <span class="keyword">if</span> (!p)</span><br><span class="line"><span class="number">6270</span>                 <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">6271</span></span><br><span class="line"><span class="number">6272</span>         dev = PTR_ALIGN(p, NETDEV_ALIGN);</span><br><span class="line"><span class="number">6273</span>         dev-&gt;padded = (<span class="type">char</span> *)dev - (<span class="type">char</span> *)p;</span><br><span class="line"><span class="number">6274</span></span><br><span class="line"><span class="number">6275</span>         dev-&gt;pcpu_refcnt = alloc_percpu(<span class="type">int</span>);</span><br><span class="line"><span class="number">6276</span>         <span class="keyword">if</span> (!dev-&gt;pcpu_refcnt)</span><br><span class="line"><span class="number">6277</span>                 <span class="keyword">goto</span> free_dev;</span><br><span class="line"><span class="number">6278</span></span><br><span class="line"><span class="number">6279</span>         <span class="keyword">if</span> (dev_addr_init(dev))</span><br><span class="line"><span class="number">6280</span>                 <span class="keyword">goto</span> free_pcpu;</span><br><span class="line"><span class="number">6281</span></span><br><span class="line"><span class="number">6282</span>         dev_mc_init(dev);</span><br><span class="line"><span class="number">6283</span>         dev_uc_init(dev);</span><br><span class="line"><span class="number">6284</span></span><br><span class="line"><span class="number">6285</span>         dev_net_set(dev, &amp;init_net);</span><br><span class="line"><span class="number">6286</span></span><br><span class="line"><span class="number">6287</span>         dev-&gt;gso_max_size = GSO_MAX_SIZE;</span><br><span class="line"><span class="number">6288</span>         dev-&gt;gso_max_segs = GSO_MAX_SEGS;</span><br><span class="line"><span class="number">6289</span></span><br><span class="line"><span class="number">6290</span>         INIT_LIST_HEAD(&amp;dev-&gt;napi_list);</span><br><span class="line"><span class="number">6291</span>         INIT_LIST_HEAD(&amp;dev-&gt;unreg_list);</span><br><span class="line"><span class="number">6292</span>         INIT_LIST_HEAD(&amp;dev-&gt;close_list);</span><br><span class="line"><span class="number">6293</span>         INIT_LIST_HEAD(&amp;dev-&gt;link_watch_list);</span><br><span class="line"><span class="number">6294</span>         INIT_LIST_HEAD(&amp;dev-&gt;adj_list.upper);</span><br><span class="line"><span class="number">6295</span>         INIT_LIST_HEAD(&amp;dev-&gt;adj_list.lower);</span><br><span class="line"><span class="number">6296</span>         INIT_LIST_HEAD(&amp;dev-&gt;all_adj_list.upper);</span><br><span class="line"><span class="number">6297</span>         INIT_LIST_HEAD(&amp;dev-&gt;all_adj_list.lower);</span><br><span class="line"><span class="number">6298</span>         dev-&gt;priv_flags = IFF_XMIT_DST_RELEASE;</span><br><span class="line"><span class="number">6299</span>         setup(dev);</span><br><span class="line"><span class="number">6300</span></span><br><span class="line"><span class="number">6301</span>         dev-&gt;num_tx_queues = txqs;</span><br><span class="line"><span class="number">6302</span>         dev-&gt;real_num_tx_queues = txqs;</span><br><span class="line"><span class="number">6303</span>         <span class="keyword">if</span> (netif_alloc_netdev_queues(dev))</span><br><span class="line"><span class="number">6304</span>                 <span class="keyword">goto</span> free_all;</span><br><span class="line"><span class="number">6305</span></span><br><span class="line"><span class="number">6306</span> <span class="meta">#<span class="keyword">ifdef</span> CONFIG_RPS</span></span><br><span class="line"><span class="number">6307</span>         dev-&gt;num_rx_queues = rxqs;</span><br><span class="line"><span class="number">6308</span>         dev-&gt;real_num_rx_queues = rxqs;</span><br><span class="line"><span class="number">6309</span>         <span class="keyword">if</span> (netif_alloc_rx_queues(dev))</span><br><span class="line"><span class="number">6310</span>                 <span class="keyword">goto</span> free_all;</span><br><span class="line"><span class="number">6311</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">6312</span></span><br><span class="line"><span class="number">6313</span>         <span class="built_in">strcpy</span>(dev-&gt;name, name);</span><br><span class="line"><span class="number">6314</span>         dev-&gt;group = INIT_NETDEV_GROUP;</span><br><span class="line"><span class="number">6315</span>         <span class="keyword">if</span> (!dev-&gt;ethtool_ops)</span><br><span class="line"><span class="number">6316</span>                 dev-&gt;ethtool_ops = &amp;default_ethtool_ops;</span><br><span class="line"><span class="number">6317</span>         <span class="keyword">return</span> dev;</span><br><span class="line"><span class="number">6318</span></span><br><span class="line"><span class="number">6319</span> free_all:</span><br><span class="line"><span class="number">6320</span>         free_netdev(dev);</span><br><span class="line"><span class="number">6321</span>         <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">6322</span></span><br><span class="line"><span class="number">6323</span> free_pcpu:</span><br><span class="line"><span class="number">6324</span>         free_percpu(dev-&gt;pcpu_refcnt);</span><br><span class="line"><span class="number">6325</span>         netif_free_tx_queues(dev);</span><br><span class="line"><span class="number">6326</span> <span class="meta">#<span class="keyword">ifdef</span> CONFIG_RPS</span></span><br><span class="line"><span class="number">6327</span>         kfree(dev-&gt;_rx);</span><br><span class="line"><span class="number">6328</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">6329</span></span><br><span class="line"><span class="number">6330</span> free_dev:</span><br><span class="line"><span class="number">6331</span>         netdev_freemem(dev);</span><br><span class="line"><span class="number">6332</span>         <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">6333</span> &#125;</span><br><span class="line"><span class="number">6334</span> EXPORT_SYMBOL(alloc_netdev_mqs);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5742</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">netif_alloc_netdev_queues</span><span class="params">(<span class="keyword">struct</span> net_device *dev)</span></span><br><span class="line">5743 &#123;</span><br><span class="line"><span class="number">5744</span>         <span class="type">unsigned</span> <span class="type">int</span> count = dev-&gt;num_tx_queues;</span><br><span class="line"><span class="number">5745</span>         <span class="class"><span class="keyword">struct</span> <span class="title">netdev_queue</span> *<span class="title">tx</span>;</span></span><br><span class="line"><span class="number">5746</span>         <span class="type">size_t</span> sz = count * <span class="keyword">sizeof</span>(*tx);</span><br><span class="line"><span class="number">5747</span></span><br><span class="line"><span class="number">5748</span>         BUG_ON(count &lt; <span class="number">1</span> || count &gt; <span class="number">0xffff</span>);</span><br><span class="line"><span class="number">5749</span></span><br><span class="line"><span class="number">5750</span>         tx = kzalloc(sz, GFP_KERNEL | __GFP_NOWARN | __GFP_REPEAT);</span><br><span class="line"><span class="number">5751</span>         <span class="keyword">if</span> (!tx) &#123;</span><br><span class="line"><span class="number">5752</span>                 tx = vzalloc(sz);</span><br><span class="line"><span class="number">5753</span>                 <span class="keyword">if</span> (!tx)</span><br><span class="line"><span class="number">5754</span>                         <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"><span class="number">5755</span>         &#125;</span><br><span class="line"><span class="number">5756</span>         dev-&gt;_tx = tx;</span><br><span class="line"><span class="number">5757</span></span><br><span class="line"><span class="number">5758</span>         netdev_for_each_tx_queue(dev, netdev_init_one_queue, <span class="literal">NULL</span>);</span><br><span class="line"><span class="number">5759</span>         spin_lock_init(&amp;dev-&gt;tx_global_lock);</span><br><span class="line"><span class="number">5760</span></span><br><span class="line"><span class="number">5761</span>         <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">5762</span> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5720</span> <span class="type">static</span> <span class="type">void</span> <span class="title function_">netdev_init_one_queue</span><span class="params">(<span class="keyword">struct</span> net_device *dev,</span></span><br><span class="line"><span class="params"><span class="number">5721</span>                                   <span class="keyword">struct</span> netdev_queue *<span class="built_in">queue</span>, <span class="type">void</span> *_unused)</span></span><br><span class="line">5722 &#123;</span><br><span class="line"><span class="number">5723</span>         <span class="comment">/* Initialize queue lock */</span></span><br><span class="line"><span class="number">5724</span>         spin_lock_init(&amp;<span class="built_in">queue</span>-&gt;_xmit_lock);</span><br><span class="line"><span class="number">5725</span>         netdev_set_xmit_lockdep_class(&amp;<span class="built_in">queue</span>-&gt;_xmit_lock, dev-&gt;type);</span><br><span class="line"><span class="number">5726</span>         <span class="built_in">queue</span>-&gt;xmit_lock_owner = <span class="number">-1</span>;</span><br><span class="line"><span class="number">5727</span>         netdev_queue_numa_node_write(<span class="built_in">queue</span>, NUMA_NO_NODE);</span><br><span class="line"><span class="number">5728</span>         <span class="built_in">queue</span>-&gt;dev = dev;</span><br><span class="line"><span class="number">5729</span> <span class="meta">#<span class="keyword">ifdef</span> CONFIG_BQL</span></span><br><span class="line"><span class="number">5730</span>         dql_init(&amp;<span class="built_in">queue</span>-&gt;dql, HZ);</span><br><span class="line"><span class="number">5731</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">5732</span> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5972</span> <span class="type">int</span> <span class="title function_">register_netdev</span><span class="params">(<span class="keyword">struct</span> net_device *dev)</span></span><br><span class="line">5973 &#123;</span><br><span class="line"><span class="number">5974</span>         <span class="type">int</span> err;</span><br><span class="line"><span class="number">5975</span></span><br><span class="line"><span class="number">5976</span>         rtnl_lock();</span><br><span class="line"><span class="number">5977</span>         err = register_netdevice(dev);</span><br><span class="line"><span class="number">5978</span>         rtnl_unlock();</span><br><span class="line"><span class="number">5979</span>         <span class="keyword">return</span> err;</span><br><span class="line"><span class="number">5980</span> &#125;</span><br><span class="line"><span class="number">5981</span> EXPORT_SYMBOL(register_netdev);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5781</span> <span class="type">int</span> <span class="title function_">register_netdevice</span><span class="params">(<span class="keyword">struct</span> net_device *dev)</span></span><br><span class="line">5782 &#123;</span><br><span class="line">...</span><br><span class="line"><span class="number">5879</span>         linkwatch_init_dev(dev);</span><br><span class="line"><span class="number">5880</span></span><br><span class="line"><span class="number">5881</span>         dev_init_scheduler(dev);</span><br><span class="line"><span class="number">5882</span>         dev_hold(dev);</span><br><span class="line"><span class="number">5883</span>         list_netdevice(dev);</span><br><span class="line"><span class="number">5884</span>         add_device_randomness(dev-&gt;dev_addr, dev-&gt;addr_len);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">876</span> <span class="type">void</span> <span class="title function_">dev_init_scheduler</span><span class="params">(<span class="keyword">struct</span> net_device *dev)</span></span><br><span class="line">877 &#123;</span><br><span class="line"><span class="number">878</span>         dev-&gt;qdisc = &amp;noop_qdisc;</span><br><span class="line"><span class="number">879</span>         netdev_for_each_tx_queue(dev, dev_init_scheduler_queue, &amp;noop_qdisc);</span><br><span class="line"><span class="number">880</span>         <span class="keyword">if</span> (dev_ingress_queue(dev))</span><br><span class="line"><span class="number">881</span>                 dev_init_scheduler_queue(dev, dev_ingress_queue(dev), &amp;noop_qdisc);</span><br><span class="line"><span class="number">882</span></span><br><span class="line"><span class="number">883</span>         setup_timer(&amp;dev-&gt;watchdog_timer, dev_watchdog, (<span class="type">unsigned</span> <span class="type">long</span>)dev);</span><br><span class="line"><span class="number">884</span> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">866 static void dev_init_scheduler_queue(struct net_device *dev,</span><br><span class="line">867                                      struct netdev_queue *dev_queue,</span><br><span class="line">868                                      void *_qdisc)</span><br><span class="line">869 &#123;</span><br><span class="line">870         struct Qdisc *qdisc = _qdisc;</span><br><span class="line">871</span><br><span class="line">872         dev_queue-&gt;qdisc = qdisc;</span><br><span class="line">873         dev_queue-&gt;qdisc_sleeping = qdisc;</span><br><span class="line">874 &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">366</span> <span class="class"><span class="keyword">struct</span> <span class="title">Qdisc</span> <span class="title">noop_qdisc</span> =</span> &#123;</span><br><span class="line"><span class="number">367</span>         .enqueue        =       noop_enqueue,</span><br><span class="line"><span class="number">368</span>         .dequeue        =       noop_dequeue,</span><br><span class="line"><span class="number">369</span>         .flags          =       TCQ_F_BUILTIN,</span><br><span class="line"><span class="number">370</span>         .ops            =       &amp;noop_qdisc_ops,</span><br><span class="line"><span class="number">371</span>         .<span class="built_in">list</span>           =       LIST_HEAD_INIT(noop_qdisc.<span class="built_in">list</span>),</span><br><span class="line"><span class="number">372</span>         .q.lock         =       __SPIN_LOCK_UNLOCKED(noop_qdisc.q.lock),</span><br><span class="line"><span class="number">373</span>         .dev_queue      =       &amp;noop_netdev_queue,</span><br><span class="line"><span class="number">374</span>         .busylock       =       __SPIN_LOCK_UNLOCKED(noop_qdisc.busylock),</span><br><span class="line"><span class="number">375</span> &#125;;</span><br></pre></td></tr></table></figure>
<h4 id="functions-for-Part-2"><a href="#functions-for-Part-2" class="headerlink" title="functions for Part 2."></a>functions for Part 2.</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">745</span> <span class="type">void</span> <span class="title function_">dev_activate</span><span class="params">(<span class="keyword">struct</span> net_device *dev)</span></span><br><span class="line">746 &#123;</span><br><span class="line"><span class="number">747</span>         <span class="type">int</span> need_watchdog;</span><br><span class="line"><span class="number">748</span></span><br><span class="line"><span class="number">749</span>         <span class="comment">/* No queueing discipline is attached to device;</span></span><br><span class="line"><span class="comment">750          * create default one for devices, which need queueing</span></span><br><span class="line"><span class="comment">751          * and noqueue_qdisc for virtual interfaces</span></span><br><span class="line"><span class="comment">752          */</span></span><br><span class="line"><span class="number">753</span></span><br><span class="line"><span class="number">754</span>         <span class="keyword">if</span> (dev-&gt;qdisc == &amp;noop_qdisc)</span><br><span class="line"><span class="number">755</span>                 attach_default_qdiscs(dev);</span><br><span class="line"><span class="number">756</span></span><br><span class="line"><span class="number">757</span>         <span class="keyword">if</span> (!netif_carrier_ok(dev))</span><br><span class="line"><span class="number">758</span>                 <span class="comment">/* Delay activation until next carrier-on event */</span></span><br><span class="line"><span class="number">759</span>                 <span class="keyword">return</span>;</span><br><span class="line"><span class="number">760</span></span><br><span class="line"><span class="number">761</span>         need_watchdog = <span class="number">0</span>;</span><br><span class="line"><span class="number">762</span>         netdev_for_each_tx_queue(dev, transition_one_qdisc, &amp;need_watchdog);</span><br><span class="line"><span class="number">763</span>         <span class="keyword">if</span> (dev_ingress_queue(dev))</span><br><span class="line"><span class="number">764</span>                 transition_one_qdisc(dev, dev_ingress_queue(dev), <span class="literal">NULL</span>);</span><br><span class="line"><span class="number">765</span></span><br><span class="line"><span class="number">766</span>         <span class="keyword">if</span> (need_watchdog) &#123;</span><br><span class="line"><span class="number">767</span>                 dev-&gt;trans_start = jiffies;</span><br><span class="line"><span class="number">768</span>                 dev_watchdog_up(dev);</span><br><span class="line"><span class="number">769</span>         &#125;</span><br><span class="line"><span class="number">770</span> &#125;</span><br><span class="line"><span class="number">771</span> EXPORT_SYMBOL(dev_activate);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">708</span> <span class="type">static</span> <span class="type">void</span> <span class="title function_">attach_default_qdiscs</span><span class="params">(<span class="keyword">struct</span> net_device *dev)</span></span><br><span class="line">709 &#123;</span><br><span class="line"><span class="number">710</span>         <span class="class"><span class="keyword">struct</span> <span class="title">netdev_queue</span> *<span class="title">txq</span>;</span></span><br><span class="line"><span class="number">711</span>         <span class="class"><span class="keyword">struct</span> <span class="title">Qdisc</span> *<span class="title">qdisc</span>;</span></span><br><span class="line"><span class="number">712</span></span><br><span class="line"><span class="number">713</span>         txq = netdev_get_tx_queue(dev, <span class="number">0</span>);</span><br><span class="line"><span class="number">714</span></span><br><span class="line"><span class="number">715</span>         <span class="keyword">if</span> (!netif_is_multiqueue(dev) || dev-&gt;tx_queue_len == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">716</span>                 netdev_for_each_tx_queue(dev, attach_one_default_qdisc, <span class="literal">NULL</span>);</span><br><span class="line"><span class="number">717</span>                 dev-&gt;qdisc = txq-&gt;qdisc_sleeping;</span><br><span class="line"><span class="number">718</span>                 <span class="type">atomic_inc</span>(&amp;dev-&gt;qdisc-&gt;refcnt);</span><br><span class="line"><span class="number">719</span>         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">720</span>                 qdisc = qdisc_create_dflt(txq, &amp;mq_qdisc_ops, TC_H_ROOT);</span><br><span class="line"><span class="number">721</span>                 <span class="keyword">if</span> (qdisc) &#123;</span><br><span class="line"><span class="number">722</span>                         qdisc-&gt;ops-&gt;attach(qdisc);</span><br><span class="line"><span class="number">723</span>                         dev-&gt;qdisc = qdisc;</span><br><span class="line"><span class="number">724</span>                 &#125;</span><br><span class="line"><span class="number">725</span>         &#125;</span><br><span class="line"><span class="number">726</span> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">223</span> <span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">Qdisc_class_ops</span> <span class="title">mq_class_ops</span> =</span> &#123;</span><br><span class="line"><span class="number">224</span>         .select_queue   = mq_select_queue,</span><br><span class="line"><span class="number">225</span>         .graft          = mq_graft,</span><br><span class="line"><span class="number">226</span>         .leaf           = mq_leaf,</span><br><span class="line"><span class="number">227</span>         .get            = mq_get,</span><br><span class="line"><span class="number">228</span>         .put            = mq_put,</span><br><span class="line"><span class="number">229</span>         .walk           = mq_walk,</span><br><span class="line"><span class="number">230</span>         .dump           = mq_dump_class,</span><br><span class="line"><span class="number">231</span>         .dump_stats     = mq_dump_class_stats,</span><br><span class="line"><span class="number">232</span> &#125;;</span><br><span class="line"><span class="number">233</span></span><br><span class="line"><span class="number">234</span> <span class="class"><span class="keyword">struct</span> <span class="title">Qdisc_ops</span> <span class="title">mq_qdisc_ops</span> __<span class="title">read_mostly</span> =</span> &#123;</span><br><span class="line"><span class="number">235</span>         .cl_ops         = &amp;mq_class_ops,</span><br><span class="line"><span class="number">236</span>         .id             = <span class="string">&quot;mq&quot;</span>,</span><br><span class="line"><span class="number">237</span>         .priv_size      = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mq_sched),</span><br><span class="line"><span class="number">238</span>         .init           = mq_init,</span><br><span class="line"><span class="number">239</span>         .destroy        = mq_destroy,</span><br><span class="line"><span class="number">240</span>         .attach         = mq_attach,</span><br><span class="line"><span class="number">241</span>         .dump           = mq_dump,</span><br><span class="line"><span class="number">242</span>         .owner          = THIS_MODULE,</span><br><span class="line"><span class="number">243</span> &#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">584</span> <span class="keyword">struct</span> Qdisc *<span class="title function_">qdisc_create_dflt</span><span class="params">(<span class="keyword">struct</span> netdev_queue *dev_queue,</span></span><br><span class="line"><span class="params"><span class="number">585</span>                                 <span class="type">const</span> <span class="keyword">struct</span> Qdisc_ops *ops,</span></span><br><span class="line"><span class="params"><span class="number">586</span>                                 <span class="type">unsigned</span> <span class="type">int</span> parentid)</span></span><br><span class="line">587 &#123;</span><br><span class="line"><span class="number">588</span>         <span class="class"><span class="keyword">struct</span> <span class="title">Qdisc</span> *<span class="title">sch</span>;</span></span><br><span class="line"><span class="number">589</span></span><br><span class="line"><span class="number">590</span>         <span class="keyword">if</span> (!try_module_get(ops-&gt;owner))</span><br><span class="line"><span class="number">591</span>                 <span class="keyword">goto</span> errout;</span><br><span class="line"><span class="number">592</span></span><br><span class="line"><span class="number">593</span>         sch = qdisc_alloc(dev_queue, ops);</span><br><span class="line"><span class="number">594</span>         <span class="keyword">if</span> (IS_ERR(sch))</span><br><span class="line"><span class="number">595</span>                 <span class="keyword">goto</span> errout;</span><br><span class="line"><span class="number">596</span>         sch-&gt;parent = parentid;</span><br><span class="line"><span class="number">597</span></span><br><span class="line"><span class="number">598</span>         <span class="keyword">if</span> (!ops-&gt;init || ops-&gt;init(sch, <span class="literal">NULL</span>) == <span class="number">0</span>)</span><br><span class="line"><span class="number">599</span>                 <span class="keyword">return</span> sch;</span><br><span class="line"><span class="number">600</span></span><br><span class="line"><span class="number">601</span>         qdisc_destroy(sch);</span><br><span class="line"><span class="number">602</span> errout:</span><br><span class="line"><span class="number">603</span>         <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">604</span> &#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://martinbj2008.github.io/2014/01/28/2014-01-28-how-to-create-dev-qdisc/" data-id="clnfhasru00are0mhes197zrw" data-title="how to create dev qdisc" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IPv4/" rel="tag">IPv4</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/netdev/" rel="tag">netdev</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/02/08/2014-02-08-qdisc-running-flag/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Qdisc running flag
        
      </div>
    </a>
  
  
    <a href="/2014/01/28/2014-01-28-qdisc-study-part1-qdisc-base/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">qdisc study part1: qdisc_base</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IPv6/">IPv6</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bpf/">bpf</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/debug/">debug</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/gcc/">gcc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/irq/">irq</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/memory/">memory</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/neighbour/">neighbour</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/netdev/">netdev</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/netlink/">netlink</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/others/">others</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/route/">route</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/sched/">sched</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/socket/">socket</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vim/">vim</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/xfrm/">xfrm</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/IPv4/" rel="tag">IPv4</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IPv6/" rel="tag">IPv6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TODO/" rel="tag">TODO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/address/" rel="tag">address</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bh/" rel="tag">bh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bpf/" rel="tag">bpf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/checksum/" rel="tag">checksum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/" rel="tag">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/epoll/" rel="tag">epoll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gcc/" rel="tag">gcc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ipv6/" rel="tag">ipv6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/irq/" rel="tag">irq</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memory/" rel="tag">memory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/namespace/" rel="tag">namespace</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/neighbour/" rel="tag">neighbour</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netdev/" rel="tag">netdev</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netlink/" rel="tag">netlink</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/others/" rel="tag">others</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ovs/" rel="tag">ovs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/route/" rel="tag">route</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sched/" rel="tag">sched</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/" rel="tag">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket-tcp/" rel="tag">socket, tcp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcp/" rel="tag">tcp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcpdump/" rel="tag">tcpdump</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/" rel="tag">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xdp/" rel="tag">xdp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xfrm/" rel="tag">xfrm</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/IPv4/" style="font-size: 20px;">IPv4</a> <a href="/tags/IPv6/" style="font-size: 10.83px;">IPv6</a> <a href="/tags/TODO/" style="font-size: 10px;">TODO</a> <a href="/tags/address/" style="font-size: 14.17px;">address</a> <a href="/tags/bh/" style="font-size: 14.17px;">bh</a> <a href="/tags/bpf/" style="font-size: 16.67px;">bpf</a> <a href="/tags/checksum/" style="font-size: 10.83px;">checksum</a> <a href="/tags/debug/" style="font-size: 11.67px;">debug</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/gcc/" style="font-size: 14.17px;">gcc</a> <a href="/tags/git/" style="font-size: 12.5px;">git</a> <a href="/tags/ipv6/" style="font-size: 10.83px;">ipv6</a> <a href="/tags/irq/" style="font-size: 17.5px;">irq</a> <a href="/tags/memory/" style="font-size: 13.33px;">memory</a> <a href="/tags/namespace/" style="font-size: 10px;">namespace</a> <a href="/tags/neighbour/" style="font-size: 10px;">neighbour</a> <a href="/tags/netdev/" style="font-size: 18.33px;">netdev</a> <a href="/tags/netlink/" style="font-size: 13.33px;">netlink</a> <a href="/tags/others/" style="font-size: 10.83px;">others</a> <a href="/tags/ovs/" style="font-size: 10px;">ovs</a> <a href="/tags/route/" style="font-size: 18.33px;">route</a> <a href="/tags/sched/" style="font-size: 14.17px;">sched</a> <a href="/tags/socket/" style="font-size: 19.17px;">socket</a> <a href="/tags/socket-tcp/" style="font-size: 10px;">socket, tcp</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/tcpdump/" style="font-size: 15.83px;">tcpdump</a> <a href="/tags/vim/" style="font-size: 11.67px;">vim</a> <a href="/tags/xdp/" style="font-size: 10.83px;">xdp</a> <a href="/tags/xfrm/" style="font-size: 15px;">xfrm</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">February 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">January 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">November 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">October 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">September 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">August 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">August 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">June 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">May 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/02/">February 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10/">October 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/09/">September 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/04/">April 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/01/">January 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/06/">June 2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/05/">May 2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/12/">December 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/11/">November 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/10/">October 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/09/">September 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/08/">August 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/07/">July 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/06/">June 2007</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/05/07/tcp-paws-check/">PAWS 在tcp协议栈中的实现</a>
          </li>
        
          <li>
            <a href="/2025/05/06/how-tcp-server-accept-a-new-connection-request/">tcp三次握手 --- 逐渐消失的tcp半链接队列</a>
          </li>
        
          <li>
            <a href="/2025/05/05/tcp-req-queue-length-check/">创建req scoket时的三个长度检查</a>
          </li>
        
          <li>
            <a href="/2025/05/03/netdev-state-flags-part2/">网口状态标志位解析part2: 内核如何维护网卡carrier的状态</a>
          </li>
        
          <li>
            <a href="/2025/05/01/netdev-state-flags-part1/">网口状态标志位详解(Part 1/2)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 Martinbj2008<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>