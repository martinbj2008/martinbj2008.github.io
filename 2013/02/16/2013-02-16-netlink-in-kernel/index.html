<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Netlink in kernel | Kernel Study Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="#netlink socket framework. ##netlink socket proto  netlink socket is a kind of socket. There are many proto of netlink. There may have many groups under each proto. See example in following. Every net">
<meta property="og:type" content="article">
<meta property="og:title" content="Netlink in kernel">
<meta property="og:url" content="https://martinbj2008.github.io/2013/02/16/2013-02-16-netlink-in-kernel/index.html">
<meta property="og:site_name" content="Kernel Study Notes">
<meta property="og:description" content="#netlink socket framework. ##netlink socket proto  netlink socket is a kind of socket. There are many proto of netlink. There may have many groups under each proto. See example in following. Every net">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2013-02-16T00:00:00.000Z">
<meta property="article:modified_time" content="2025-05-28T12:13:09.551Z">
<meta property="article:author" content="Martinbj2008">
<meta property="article:tag" content="netlink">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Kernel Study Notes" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Kernel Study Notes</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://martinbj2008.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-2013-02-16-netlink-in-kernel" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2013/02/16/2013-02-16-netlink-in-kernel/" class="article-date">
  <time class="dt-published" datetime="2013-02-16T00:00:00.000Z" itemprop="datePublished">2013-02-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/netlink/">netlink</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Netlink in kernel
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>#netlink socket framework.</p>
<p>##netlink socket proto<br>  netlink socket is a kind of socket. There are many proto of netlink. There may have many groups under each proto. See example in following.</p>
<p>Every netlink socket is indicated by <code>&lt;net, proto, pid&gt;</code>.</p>
<ol>
<li>net: the net namespace.</li>
<li>proto: netlink proto.</li>
<li>pid:</li>
</ol>
<span id="more"></span>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">7</span> <span class="meta">#<span class="keyword">define</span> NETLINK_ROUTE           0       <span class="comment">/* Routing/device hook                          */</span></span></span><br><span class="line"> <span class="number">8</span> <span class="meta">#<span class="keyword">define</span> NETLINK_UNUSED          1       <span class="comment">/* Unused number                                */</span></span></span><br><span class="line"> <span class="number">9</span> <span class="meta">#<span class="keyword">define</span> NETLINK_USERSOCK        2       <span class="comment">/* Reserved for user mode socket protocols      */</span></span></span><br><span class="line"><span class="number">10</span> <span class="meta">#<span class="keyword">define</span> NETLINK_FIREWALL        3       <span class="comment">/* Firewalling hook                             */</span></span></span><br><span class="line"><span class="number">11</span> <span class="meta">#<span class="keyword">define</span> NETLINK_SOCK_DIAG       4       <span class="comment">/* socket monitoring                            */</span></span></span><br><span class="line"><span class="number">12</span> <span class="meta">#<span class="keyword">define</span> NETLINK_NFLOG           5       <span class="comment">/* netfilter/iptables ULOG */</span></span></span><br><span class="line"><span class="number">13</span> <span class="meta">#<span class="keyword">define</span> NETLINK_XFRM            6       <span class="comment">/* ipsec */</span></span></span><br><span class="line"><span class="number">14</span> <span class="meta">#<span class="keyword">define</span> NETLINK_SELINUX         7       <span class="comment">/* SELinux event notifications */</span></span></span><br><span class="line"><span class="number">15</span> <span class="meta">#<span class="keyword">define</span> NETLINK_ISCSI           8       <span class="comment">/* Open-iSCSI */</span></span></span><br><span class="line"><span class="number">16</span> <span class="meta">#<span class="keyword">define</span> NETLINK_AUDIT           9       <span class="comment">/* auditing */</span></span></span><br><span class="line"><span class="number">17</span> <span class="meta">#<span class="keyword">define</span> NETLINK_FIB_LOOKUP      10</span></span><br><span class="line"><span class="number">18</span> <span class="meta">#<span class="keyword">define</span> NETLINK_CONNECTOR       11</span></span><br><span class="line"><span class="number">19</span> <span class="meta">#<span class="keyword">define</span> NETLINK_NETFILTER       12      <span class="comment">/* netfilter subsystem */</span></span></span><br><span class="line"><span class="number">20</span> <span class="meta">#<span class="keyword">define</span> NETLINK_IP6_FW          13</span></span><br><span class="line"><span class="number">21</span> <span class="meta">#<span class="keyword">define</span> NETLINK_DNRTMSG         14      <span class="comment">/* DECnet routing messages */</span></span></span><br><span class="line"><span class="number">22</span> <span class="meta">#<span class="keyword">define</span> NETLINK_KOBJECT_UEVENT  15      <span class="comment">/* Kernel messages to userspace */</span></span></span><br><span class="line"><span class="number">23</span> <span class="meta">#<span class="keyword">define</span> NETLINK_GENERIC         16</span></span><br><span class="line"><span class="number">24</span> <span class="comment">/* leave room for NETLINK_DM (DM Events) */</span></span><br><span class="line"><span class="number">25</span> <span class="meta">#<span class="keyword">define</span> NETLINK_SCSITRANSPORT   18      <span class="comment">/* SCSI Transports */</span></span></span><br><span class="line"><span class="number">26</span> <span class="meta">#<span class="keyword">define</span> NETLINK_ECRYPTFS        19</span></span><br><span class="line"><span class="number">27</span> <span class="meta">#<span class="keyword">define</span> NETLINK_RDMA            20</span></span><br><span class="line"><span class="number">28</span> <span class="meta">#<span class="keyword">define</span> NETLINK_CRYPTO          21      <span class="comment">/* Crypto layer */</span></span></span><br><span class="line"><span class="number">29</span></span><br><span class="line"><span class="number">30</span> <span class="meta">#<span class="keyword">define</span> NETLINK_INET_DIAG       NETLINK_SOCK_DIAG</span></span><br><span class="line"><span class="number">31</span></span><br><span class="line"><span class="number">32</span> <span class="meta">#<span class="keyword">define</span> MAX_LINKS 32</span></span><br></pre></td></tr></table></figure>
<p>Each proto of netlink has many groups, for example xfrm netlink:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">462</span> <span class="class"><span class="keyword">enum</span> <span class="title">xfrm_nlgroups</span> &#123;</span></span><br><span class="line"><span class="number">463</span>         XFRMNLGRP_NONE,</span><br><span class="line"><span class="number">464</span> <span class="meta">#<span class="keyword">define</span> XFRMNLGRP_NONE          XFRMNLGRP_NONE</span></span><br><span class="line"><span class="number">465</span>         XFRMNLGRP_ACQUIRE,</span><br><span class="line"><span class="number">466</span> <span class="meta">#<span class="keyword">define</span> XFRMNLGRP_ACQUIRE       XFRMNLGRP_ACQUIRE</span></span><br><span class="line"><span class="number">467</span>         XFRMNLGRP_EXPIRE,</span><br><span class="line"><span class="number">468</span> <span class="meta">#<span class="keyword">define</span> XFRMNLGRP_EXPIRE        XFRMNLGRP_EXPIRE</span></span><br><span class="line"><span class="number">469</span>         XFRMNLGRP_SA,</span><br><span class="line"><span class="number">470</span> <span class="meta">#<span class="keyword">define</span> XFRMNLGRP_SA            XFRMNLGRP_SA</span></span><br><span class="line"><span class="number">471</span>         XFRMNLGRP_POLICY,</span><br><span class="line"><span class="number">472</span> <span class="meta">#<span class="keyword">define</span> XFRMNLGRP_POLICY        XFRMNLGRP_POLICY</span></span><br><span class="line"><span class="number">473</span>         XFRMNLGRP_AEVENTS,</span><br><span class="line"><span class="number">474</span> <span class="meta">#<span class="keyword">define</span> XFRMNLGRP_AEVENTS       XFRMNLGRP_AEVENTS</span></span><br><span class="line"><span class="number">475</span>         XFRMNLGRP_REPORT,</span><br><span class="line"><span class="number">476</span> <span class="meta">#<span class="keyword">define</span> XFRMNLGRP_REPORT        XFRMNLGRP_REPORT</span></span><br><span class="line"><span class="number">477</span>         XFRMNLGRP_MIGRATE,</span><br><span class="line"><span class="number">478</span> <span class="meta">#<span class="keyword">define</span> XFRMNLGRP_MIGRATE       XFRMNLGRP_MIGRATE</span></span><br><span class="line"><span class="number">479</span>         XFRMNLGRP_MAPPING,</span><br><span class="line"><span class="number">480</span> <span class="meta">#<span class="keyword">define</span> XFRMNLGRP_MAPPING       XFRMNLGRP_MAPPING</span></span><br><span class="line"><span class="number">481</span>         __XFRMNLGRP_MAX</span><br><span class="line"><span class="number">482</span> &#125;;</span><br><span class="line"><span class="number">483</span> <span class="meta">#<span class="keyword">define</span> XFRMNLGRP_MAX   (__XFRMNLGRP_MAX - 1)</span></span><br></pre></td></tr></table></figure>
<p>all the supported protos are stored in the array <code>nl_table</code>.</p>
<p><code>static struct netlink_table *nl_table</code>;</p>
<p>each type is stored in a struct netlink_table</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">119</span> <span class="class"><span class="keyword">struct</span> <span class="title">netlink_table</span> &#123;</span></span><br><span class="line"><span class="number">120</span>         <span class="class"><span class="keyword">struct</span> <span class="title">nl_pid_hash</span> <span class="title">hash</span>;</span>          <span class="comment">/* store all the netlink socket with hash list */</span></span><br><span class="line"><span class="number">121</span>         <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">mc_list</span>;</span>            <span class="comment">/* store all the netlink socket listen broadcast netlink message */</span></span><br><span class="line"><span class="number">122</span>         <span class="class"><span class="keyword">struct</span> <span class="title">listeners</span> __<span class="title">rcu</span> *<span class="title">listeners</span>;</span>      <span class="comment">/* store with a bit(1) for each netlink broadcast type, which is listened by one or more netlink sockets in mc_list(line 121) */</span></span><br><span class="line"><span class="number">123</span>         <span class="type">unsigned</span> <span class="type">int</span> nl_nonroot;</span><br><span class="line"><span class="number">124</span>         <span class="type">unsigned</span> <span class="type">int</span> groups;            <span class="comment">/* the counts of bits in listeners(line 122)*/</span></span><br><span class="line"><span class="number">125</span>         <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> *<span class="title">cb_mutex</span>;</span></span><br><span class="line"><span class="number">126</span>         <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">module</span>;</span></span><br><span class="line"><span class="number">127</span>         <span class="type">int</span> registered;             <span class="comment">/* avoid repeated register. */</span></span><br><span class="line"><span class="number">128</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>In initialization, each type netlink call netlink_kernel_create, which will prepare two parts:</p>
<ol>
<li>Register in a netlink_table of nl_table,</li>
<li>Create a netlink kernel socket for the registered proto.</li>
</ol>
<p>##Example: xfrm netlink<br>  Register a netlink type with NETLINK_XFRM, which has XFRMNLGRP_MAX groups. and all the netlink message will be processed by xfrm_netlink_rcv.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2603</span> <span class="type">static</span> <span class="type">int</span> __net_init <span class="title function_">xfrm_user_net_init</span><span class="params">(<span class="keyword">struct</span> net *net)</span></span><br><span class="line">2604 &#123;</span><br><span class="line"><span class="number">2605</span>         <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">nlsk</span>;</span></span><br><span class="line"><span class="number">2606</span></span><br><span class="line"><span class="number">2607</span>         nlsk = netlink_kernel_create(net, NETLINK_XFRM, XFRMNLGRP_MAX,</span><br><span class="line"><span class="number">2608</span>                                      xfrm_netlink_rcv, <span class="literal">NULL</span>, THIS_MODULE);</span><br><span class="line"><span class="number">2609</span>         <span class="keyword">if</span> (nlsk == <span class="literal">NULL</span>)</span><br><span class="line"><span class="number">2610</span>                 <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"><span class="number">2611</span>         rcu_assign_pointer(net-&gt;xfrm.nlsk, nlsk);</span><br><span class="line"><span class="number">2612</span>         <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">2613</span> &#125;</span><br></pre></td></tr></table></figure>
<p>###Data struct &amp;&amp; method</p>
<p>####struct netlink_sock</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">67</span> <span class="class"><span class="keyword">struct</span> <span class="title">netlink_sock</span> &#123;</span></span><br><span class="line"><span class="number">68</span>         <span class="comment">/* struct sock has to be the first member of netlink_sock */</span></span><br><span class="line"><span class="number">69</span>         <span class="class"><span class="keyword">struct</span> <span class="title">sock</span>             <span class="title">sk</span>;</span></span><br><span class="line"><span class="number">70</span>         u32                     pid;</span><br><span class="line"><span class="number">71</span>         u32                     dst_pid;</span><br><span class="line"><span class="number">72</span>         u32                     dst_group;</span><br><span class="line"><span class="number">73</span>         u32                     flags;</span><br><span class="line"><span class="number">74</span>         u32                     subscriptions;</span><br><span class="line"><span class="number">75</span>         u32                     ngroups;</span><br><span class="line"><span class="number">76</span>         <span class="type">unsigned</span> <span class="type">long</span>           *groups;</span><br><span class="line"><span class="number">77</span>         <span class="type">unsigned</span> <span class="type">long</span>           state;</span><br><span class="line"><span class="number">78</span>         <span class="type">wait_queue_head_t</span>       wait;</span><br><span class="line"><span class="number">79</span>         <span class="class"><span class="keyword">struct</span> <span class="title">netlink_callback</span> *<span class="title">cb</span>;</span></span><br><span class="line"><span class="number">80</span>         <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>            *<span class="title">cb_mutex</span>;</span></span><br><span class="line"><span class="number">81</span>         <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>            <span class="title">cb_def_mutex</span>;</span></span><br><span class="line"><span class="number">82</span>         <span class="type">void</span>                    (*netlink_rcv)(<span class="keyword">struct</span> sk_buff *skb);</span><br><span class="line"><span class="number">83</span>         <span class="class"><span class="keyword">struct</span> <span class="title">module</span>           *<span class="title">module</span>;</span></span><br><span class="line"><span class="number">84</span> &#125;;</span><br></pre></td></tr></table></figure>

<p>Every netlink socket has a pid. The pid of netlink kernel sockets is 0. All the the netlink message need kernel process, will be sent to them. (net, pid, protocol) will be used to locate the destination of a netlink message.</p>
<p>####netlink_create</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">430</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">netlink_create</span><span class="params">(<span class="keyword">struct</span> net *net, <span class="keyword">struct</span> socket *sock, <span class="type">int</span> protocol,</span></span><br><span class="line"><span class="params"><span class="number">431</span>                           <span class="type">int</span> kern)</span></span><br><span class="line">432 &#123;</span><br><span class="line"><span class="number">433</span>         <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">module</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">434</span>         <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> *<span class="title">cb_mutex</span>;</span></span><br><span class="line"><span class="number">435</span>         <span class="class"><span class="keyword">struct</span> <span class="title">netlink_sock</span> *<span class="title">nlk</span>;</span></span><br><span class="line"><span class="number">436</span>         <span class="type">int</span> err = <span class="number">0</span>;</span><br><span class="line"><span class="number">437</span></span><br><span class="line"><span class="number">438</span>         sock-&gt;state = SS_UNCONNECTED;</span><br><span class="line"><span class="number">439</span></span><br><span class="line"><span class="number">440</span>         <span class="keyword">if</span> (sock-&gt;type != SOCK_RAW &amp;&amp; sock-&gt;type != SOCK_DGRAM)</span><br><span class="line"><span class="number">441</span>                 <span class="keyword">return</span> -ESOCKTNOSUPPORT;</span><br><span class="line"><span class="number">442</span></span><br><span class="line"><span class="number">443</span>         <span class="keyword">if</span> (protocol &lt; <span class="number">0</span> || protocol &gt;= MAX_LINKS)</span><br><span class="line"><span class="number">444</span>                 <span class="keyword">return</span> -EPROTONOSUPPORT;</span><br><span class="line"><span class="number">445</span></span><br><span class="line"><span class="number">446</span>         netlink_lock_table();</span><br><span class="line"><span class="number">447</span> <span class="meta">#<span class="keyword">ifdef</span> CONFIG_MODULES</span></span><br><span class="line"><span class="number">448</span>         <span class="keyword">if</span> (!nl_table[protocol].registered) &#123;</span><br><span class="line"><span class="number">449</span>                 netlink_unlock_table();</span><br><span class="line"><span class="number">450</span>                 request_module(<span class="string">&quot;net-pf-%d-proto-%d&quot;</span>, PF_NETLINK, protocol);</span><br><span class="line"><span class="number">451</span>                 netlink_lock_table();</span><br><span class="line"><span class="number">452</span>         &#125;</span><br><span class="line"><span class="number">453</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">454</span>         <span class="keyword">if</span> (nl_table[protocol].registered &amp;&amp;</span><br><span class="line"><span class="number">455</span>             try_module_get(nl_table[protocol].module))</span><br><span class="line"><span class="number">456</span>                 module = nl_table[protocol].module;</span><br><span class="line"><span class="number">457</span>         <span class="keyword">else</span></span><br><span class="line"><span class="number">458</span>                 err = -EPROTONOSUPPORT;</span><br><span class="line"><span class="number">459</span>         cb_mutex = nl_table[protocol].cb_mutex;</span><br><span class="line"><span class="number">460</span>         netlink_unlock_table();</span><br><span class="line"><span class="number">461</span></span><br><span class="line"><span class="number">462</span>         <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="number">463</span>                 <span class="keyword">goto</span> out;</span><br><span class="line"><span class="number">464</span></span><br><span class="line"><span class="number">465</span>         err = __netlink_create(net, sock, cb_mutex, protocol);</span><br><span class="line"><span class="number">466</span>         <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="number">467</span>                 <span class="keyword">goto</span> out_module;</span><br><span class="line"><span class="number">468</span></span><br><span class="line"><span class="number">469</span>         local_bh_disable();</span><br><span class="line"><span class="number">470</span>         sock_prot_inuse_add(net, &amp;netlink_proto, <span class="number">1</span>);</span><br><span class="line"><span class="number">471</span>         local_bh_enable();</span><br><span class="line"><span class="number">472</span></span><br><span class="line"><span class="number">473</span>         nlk = nlk_sk(sock-&gt;sk);</span><br><span class="line"><span class="number">474</span>         nlk-&gt;module = module;</span><br><span class="line"><span class="number">475</span> out:</span><br><span class="line"><span class="number">476</span>         <span class="keyword">return</span> err;</span><br><span class="line"><span class="number">477</span></span><br><span class="line"><span class="number">478</span> out_module:</span><br><span class="line"><span class="number">479</span>         module_put(module);</span><br><span class="line"><span class="number">480</span>         <span class="keyword">goto</span> out;</span><br><span class="line"><span class="number">481</span> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">402</span> <span class="type">static</span> <span class="type">int</span> __netlink_create(<span class="keyword">struct</span> net *net, <span class="keyword">struct</span> socket *sock,</span><br><span class="line"><span class="number">403</span>                             <span class="keyword">struct</span> mutex *cb_mutex, <span class="type">int</span> protocol)</span><br><span class="line"><span class="number">404</span> &#123;</span><br><span class="line"><span class="number">405</span>         <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line"><span class="number">406</span>         <span class="class"><span class="keyword">struct</span> <span class="title">netlink_sock</span> *<span class="title">nlk</span>;</span></span><br><span class="line"><span class="number">407</span></span><br><span class="line"><span class="number">408</span>         sock-&gt;ops = &amp;netlink_ops;</span><br><span class="line"><span class="number">409</span></span><br><span class="line"><span class="number">410</span>         sk = sk_alloc(net, PF_NETLINK, GFP_KERNEL, &amp;netlink_proto);</span><br><span class="line"><span class="number">411</span>         <span class="keyword">if</span> (!sk)</span><br><span class="line"><span class="number">412</span>                 <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"><span class="number">413</span></span><br><span class="line"><span class="number">414</span>         sock_init_data(sock, sk);</span><br><span class="line"><span class="number">415</span></span><br><span class="line"><span class="number">416</span>         nlk = nlk_sk(sk);</span><br><span class="line"><span class="number">417</span>         <span class="keyword">if</span> (cb_mutex)</span><br><span class="line"><span class="number">418</span>                 nlk-&gt;cb_mutex = cb_mutex;</span><br><span class="line"><span class="number">419</span>         <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">420</span>                 nlk-&gt;cb_mutex = &amp;nlk-&gt;cb_def_mutex;</span><br><span class="line"><span class="number">421</span>                 mutex_init(nlk-&gt;cb_mutex);</span><br><span class="line"><span class="number">422</span>         &#125;</span><br><span class="line"><span class="number">423</span>         init_waitqueue_head(&amp;nlk-&gt;wait);</span><br><span class="line"><span class="number">424</span></span><br><span class="line"><span class="number">425</span>         sk-&gt;sk_destruct = netlink_sock_destruct;</span><br><span class="line"><span class="number">426</span>         sk-&gt;sk_protocol = protocol;</span><br><span class="line"><span class="number">427</span>         <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">428</span> &#125;</span><br></pre></td></tr></table></figure>

<p>####netlink_sendmsg</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netlink_sendmsg —–&gt; netlink_unicastg —–&gt; nlk-&gt;netlink_rcv,</span><br></pre></td></tr></table></figure>
<p>Create a skb and init <code>NETLINK_CB(skb)</code>, Copy the message data with memcpy_fromiovec.</p>
<p>If its destination is a group, then broadcast it with netlink_broadcast, or it is a unicast message, send it by netlink_unicast.</p>
<p><code>nlk-&gt;netlink_rcv</code> is set in <code>netlink_create</code> for xfrm netlink message, it is<code>xfrm_netlink_rcv</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1313</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">netlink_sendmsg</span><span class="params">(<span class="keyword">struct</span> kiocb *kiocb, <span class="keyword">struct</span> socket *sock,</span></span><br><span class="line"><span class="params"><span class="number">1314</span>                            <span class="keyword">struct</span> msghdr *msg, <span class="type">size_t</span> len)</span></span><br><span class="line">1315 &#123;</span><br><span class="line"><span class="number">1316</span>         <span class="class"><span class="keyword">struct</span> <span class="title">sock_iocb</span> *<span class="title">siocb</span> =</span> kiocb_to_siocb(kiocb);</span><br><span class="line"><span class="number">1317</span>         <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line"><span class="number">1318</span>         <span class="class"><span class="keyword">struct</span> <span class="title">netlink_sock</span> *<span class="title">nlk</span> =</span> nlk_sk(sk);</span><br><span class="line"><span class="number">1319</span>         <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> *<span class="title">addr</span> =</span> msg-&gt;msg_name;</span><br><span class="line"><span class="number">1320</span>         u32 dst_pid;</span><br><span class="line"><span class="number">1321</span>         u32 dst_group;</span><br><span class="line"><span class="number">1322</span>         <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line"><span class="number">1323</span>         <span class="type">int</span> err;</span><br><span class="line"><span class="number">1324</span>         <span class="class"><span class="keyword">struct</span> <span class="title">scm_cookie</span> <span class="title">scm</span>;</span></span><br><span class="line"><span class="number">1325</span></span><br><span class="line"><span class="number">1326</span>         <span class="keyword">if</span> (msg-&gt;msg_flags&amp;MSG_OOB)</span><br><span class="line"><span class="number">1327</span>                 <span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"><span class="number">1328</span></span><br><span class="line"><span class="number">1329</span>         <span class="keyword">if</span> (<span class="literal">NULL</span> == siocb-&gt;scm)</span><br><span class="line"><span class="number">1330</span>                 siocb-&gt;scm = &amp;scm;</span><br><span class="line"><span class="number">1331</span></span><br><span class="line"><span class="number">1332</span>         err = scm_send(sock, msg, siocb-&gt;scm, <span class="literal">true</span>);</span><br><span class="line"><span class="number">1333</span>         <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="number">1334</span>                 <span class="keyword">return</span> err;</span><br><span class="line"><span class="number">1335</span></span><br><span class="line"><span class="number">1336</span>         <span class="keyword">if</span> (msg-&gt;msg_namelen) &#123;</span><br><span class="line"><span class="number">1337</span>                 err = -EINVAL;</span><br><span class="line"><span class="number">1338</span>                 <span class="keyword">if</span> (addr-&gt;nl_family != AF_NETLINK)</span><br><span class="line"><span class="number">1339</span>                         <span class="keyword">goto</span> out;</span><br><span class="line"><span class="number">1340</span>                 dst_pid = addr-&gt;nl_pid;</span><br><span class="line"><span class="number">1341</span>                 dst_group = ffs(addr-&gt;nl_groups);</span><br><span class="line"><span class="number">1342</span>                 err =  -EPERM;</span><br><span class="line"><span class="number">1343</span>                 <span class="keyword">if</span> ((dst_group || dst_pid) &amp;&amp;</span><br><span class="line"><span class="number">1344</span>                     !netlink_capable(sock, NL_NONROOT_SEND))</span><br><span class="line"><span class="number">1345</span>                         <span class="keyword">goto</span> out;</span><br><span class="line"><span class="number">1346</span>         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">1347</span>                 dst_pid = nlk-&gt;dst_pid;</span><br><span class="line"><span class="number">1348</span>                 dst_group = nlk-&gt;dst_group;</span><br><span class="line"><span class="number">1349</span>         &#125;</span><br><span class="line"><span class="number">1350</span></span><br><span class="line"><span class="number">1351</span>         <span class="keyword">if</span> (!nlk-&gt;pid) &#123;</span><br><span class="line"><span class="number">1352</span>                 err = netlink_autobind(sock);</span><br><span class="line"><span class="number">1353</span>                 <span class="keyword">if</span> (err)</span><br><span class="line"><span class="number">1354</span>                         <span class="keyword">goto</span> out;</span><br><span class="line"><span class="number">1355</span>         &#125;</span><br><span class="line"><span class="number">1356</span></span><br><span class="line"><span class="number">1357</span>         err = -EMSGSIZE;</span><br><span class="line"><span class="number">1358</span>         <span class="keyword">if</span> (len &gt; sk-&gt;sk_sndbuf - <span class="number">32</span>)</span><br><span class="line"><span class="number">1359</span>                 <span class="keyword">goto</span> out;</span><br><span class="line"><span class="number">1360</span>         err = -ENOBUFS;</span><br><span class="line"><span class="number">1361</span>         skb = alloc_skb(len, GFP_KERNEL);</span><br><span class="line"><span class="number">1362</span>         <span class="keyword">if</span> (skb == <span class="literal">NULL</span>)</span><br><span class="line"><span class="number">1363</span>                 <span class="keyword">goto</span> out;</span><br><span class="line"><span class="number">1364</span></span><br><span class="line"><span class="number">1365</span>         NETLINK_CB(skb).pid     = nlk-&gt;pid;</span><br><span class="line"><span class="number">1366</span>         NETLINK_CB(skb).dst_group = dst_group;</span><br><span class="line"><span class="number">1367</span>         <span class="built_in">memcpy</span>(NETLINK_CREDS(skb), &amp;siocb-&gt;scm-&gt;creds, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ucred));</span><br><span class="line"><span class="number">1368</span></span><br><span class="line"><span class="number">1369</span>         err = -EFAULT;</span><br><span class="line"><span class="number">1370</span>         <span class="keyword">if</span> (memcpy_fromiovec(skb_put(skb, len), msg-&gt;msg_iov, len)) &#123;</span><br><span class="line"><span class="number">1371</span>                 kfree_skb(skb);</span><br><span class="line"><span class="number">1372</span>                 <span class="keyword">goto</span> out;</span><br><span class="line"><span class="number">1373</span>         &#125;</span><br><span class="line"><span class="number">1374</span></span><br><span class="line"><span class="number">1375</span>         err = security_netlink_send(sk, skb);</span><br><span class="line"><span class="number">1376</span>         <span class="keyword">if</span> (err) &#123;</span><br><span class="line"><span class="number">1377</span>                 kfree_skb(skb);</span><br><span class="line"><span class="number">1378</span>                 <span class="keyword">goto</span> out;</span><br><span class="line"><span class="number">1379</span>         &#125;</span><br><span class="line"><span class="number">1380</span></span><br><span class="line"><span class="number">1381</span>         <span class="keyword">if</span> (dst_group) &#123;</span><br><span class="line"><span class="number">1382</span>                 <span class="type">atomic_inc</span>(&amp;skb-&gt;users);</span><br><span class="line"><span class="number">1383</span>                 netlink_broadcast(sk, skb, dst_pid, dst_group, GFP_KERNEL);</span><br><span class="line"><span class="number">1384</span>         &#125;</span><br><span class="line"><span class="number">1385</span>         err = netlink_unicast(sk, skb, dst_pid, msg-&gt;msg_flags&amp;MSG_DONTWAIT);</span><br><span class="line"><span class="number">1386</span></span><br><span class="line"><span class="number">1387</span> out:</span><br><span class="line"><span class="number">1388</span>         scm_destroy(siocb-&gt;scm);</span><br><span class="line"><span class="number">1389</span>         <span class="keyword">return</span> err;</span><br><span class="line"><span class="number">1390</span> &#125;</span><br></pre></td></tr></table></figure>
<p>###netlink_unicast<br>  find the dest netlink socket by its pid.<br>if dst socket is a kernl socket, call netlink_unicast_kernel. for example : in the case, dump xfrm sa. else put the skb into the dest socket recv queue.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">891</span> <span class="type">int</span> <span class="title function_">netlink_unicast</span><span class="params">(<span class="keyword">struct</span> sock ssk, <span class="keyword">struct</span> sk_buff skb, </span></span><br><span class="line"><span class="params"><span class="number">892</span> u32 pid, <span class="type">int</span> nonblock)</span></span><br><span class="line">893 &#123; </span><br><span class="line"><span class="number">894</span> <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span> </span><br><span class="line"><span class="number">895</span> <span class="type">int</span> err; </span><br><span class="line"><span class="number">896</span> <span class="type">long</span> timeo; </span><br><span class="line"><span class="number">897</span> </span><br><span class="line"><span class="number">898</span> skb = netlink_trim(skb, gfp_any()); </span><br><span class="line"><span class="number">899</span> </span><br><span class="line"><span class="number">900</span> timeo = sock_sndtimeo(ssk, nonblock); </span><br><span class="line"><span class="number">901</span> retry: </span><br><span class="line"><span class="number">902</span> sk = netlink_getsockbypid(ssk, pid); </span><br><span class="line"><span class="number">903</span> <span class="keyword">if</span> (IS_ERR(sk)) &#123; </span><br><span class="line"><span class="number">904</span> kfree_skb(skb); </span><br><span class="line"><span class="number">905</span> <span class="keyword">return</span> PTR_ERR(sk); </span><br><span class="line"><span class="number">906</span> &#125; </span><br><span class="line"><span class="number">907</span> <span class="keyword">if</span> (netlink_is_kernel(sk)) </span><br><span class="line"><span class="number">908</span> <span class="keyword">return</span> netlink_unicast_kernel(sk, skb); </span><br><span class="line"><span class="number">909</span> </span><br><span class="line"><span class="number">910</span> <span class="keyword">if</span> (sk_filter(sk, skb)) &#123; </span><br><span class="line"><span class="number">911</span> err = skb-&gt;len; </span><br><span class="line"><span class="number">912</span> kfree_skb(skb); </span><br><span class="line"><span class="number">913</span> sock_put(sk); </span><br><span class="line"><span class="number">914</span> <span class="keyword">return</span> err; </span><br><span class="line"><span class="number">915</span> &#125; </span><br><span class="line"><span class="number">916</span> </span><br><span class="line"><span class="number">917</span> err = netlink_attachskb(sk, skb, &amp;timeo, ssk); </span><br><span class="line"><span class="number">918</span> <span class="keyword">if</span> (err == <span class="number">1</span>) </span><br><span class="line"><span class="number">919</span> <span class="keyword">goto</span> retry; </span><br><span class="line"><span class="number">920</span> <span class="keyword">if</span> (err) </span><br><span class="line"><span class="number">921</span> <span class="keyword">return</span> err; </span><br><span class="line"><span class="number">922</span> </span><br><span class="line"><span class="number">923</span> <span class="keyword">return</span> netlink_sendskb(sk, skb); </span><br><span class="line"><span class="number">924</span> &#125; </span><br><span class="line"><span class="number">925</span> EXPORT_SYMBOL(netlink_unicast);</span><br></pre></td></tr></table></figure>

<p>###broadcast message</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">905</span> <span class="type">int</span> <span class="title function_">netlink_unicast</span><span class="params">(<span class="keyword">struct</span> sock *ssk, <span class="keyword">struct</span> sk_buff *skb,</span></span><br><span class="line"><span class="params"><span class="number">906</span>                     u32 pid, <span class="type">int</span> nonblock)</span></span><br><span class="line">907 &#123;</span><br><span class="line"><span class="number">908</span>         <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line"><span class="number">909</span>         <span class="type">int</span> err;</span><br><span class="line"><span class="number">910</span>         <span class="type">long</span> timeo;</span><br><span class="line"><span class="number">911</span></span><br><span class="line"><span class="number">912</span>         skb = netlink_trim(skb, gfp_any());</span><br><span class="line"><span class="number">913</span></span><br><span class="line"><span class="number">914</span>         timeo = sock_sndtimeo(ssk, nonblock);</span><br><span class="line"><span class="number">915</span> retry:</span><br><span class="line"><span class="number">916</span>         sk = netlink_getsockbypid(ssk, pid);</span><br><span class="line"><span class="number">917</span>         <span class="keyword">if</span> (IS_ERR(sk)) &#123;</span><br><span class="line"><span class="number">918</span>                 kfree_skb(skb);</span><br><span class="line"><span class="number">919</span>                 <span class="keyword">return</span> PTR_ERR(sk);</span><br><span class="line"><span class="number">920</span>         &#125;</span><br><span class="line"><span class="number">921</span>         <span class="keyword">if</span> (netlink_is_kernel(sk))</span><br><span class="line"><span class="number">922</span>                 <span class="keyword">return</span> netlink_unicast_kernel(sk, skb);</span><br><span class="line"><span class="number">923</span></span><br><span class="line"><span class="number">924</span>         <span class="keyword">if</span> (sk_filter(sk, skb)) &#123;</span><br><span class="line"><span class="number">925</span>                 err = skb-&gt;len;</span><br><span class="line"><span class="number">926</span>                 kfree_skb(skb);</span><br><span class="line"><span class="number">927</span>                 sock_put(sk);</span><br><span class="line"><span class="number">928</span>                 <span class="keyword">return</span> err;</span><br><span class="line"><span class="number">929</span>         &#125;</span><br><span class="line"><span class="number">930</span></span><br><span class="line"><span class="number">931</span>         err = netlink_attachskb(sk, skb, &amp;timeo, ssk);</span><br><span class="line"><span class="number">932</span>         <span class="keyword">if</span> (err == <span class="number">1</span>)</span><br><span class="line"><span class="number">933</span>                 <span class="keyword">goto</span> retry;</span><br><span class="line"><span class="number">934</span>         <span class="keyword">if</span> (err)</span><br><span class="line"><span class="number">935</span>                 <span class="keyword">return</span> err;</span><br><span class="line"><span class="number">936</span></span><br><span class="line"><span class="number">937</span>         <span class="keyword">return</span> netlink_sendskb(sk, skb);</span><br><span class="line"><span class="number">938</span> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">889</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">netlink_unicast_kernel</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="keyword">struct</span> sk_buff *skb)</span></span><br><span class="line">890 &#123;</span><br><span class="line"><span class="number">891</span>         <span class="type">int</span> ret;</span><br><span class="line"><span class="number">892</span>         <span class="class"><span class="keyword">struct</span> <span class="title">netlink_sock</span> *<span class="title">nlk</span> =</span> nlk_sk(sk);</span><br><span class="line"><span class="number">893</span></span><br><span class="line"><span class="number">894</span>         ret = -ECONNREFUSED;</span><br><span class="line"><span class="number">895</span>         <span class="keyword">if</span> (nlk-&gt;netlink_rcv != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="number">896</span>                 ret = skb-&gt;len;</span><br><span class="line"><span class="number">897</span>                 skb_set_owner_r(skb, sk);</span><br><span class="line"><span class="number">898</span>                 nlk-&gt;netlink_rcv(skb);</span><br><span class="line"><span class="number">899</span>         &#125;</span><br><span class="line"><span class="number">900</span>         kfree_skb(skb);</span><br><span class="line"><span class="number">901</span>         sock_put(sk);</span><br><span class="line"><span class="number">902</span>         <span class="keyword">return</span> ret;</span><br><span class="line"><span class="number">903</span> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">86</span> <span class="class"><span class="keyword">struct</span> <span class="title">listeners</span> &#123;</span></span><br><span class="line"><span class="number">87</span>         <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>         <span class="title">rcu</span>;</span></span><br><span class="line"><span class="number">88</span>         <span class="type">unsigned</span> <span class="type">long</span>           masks[<span class="number">0</span>];</span><br><span class="line"><span class="number">89</span> &#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">106</span> <span class="class"><span class="keyword">struct</span> <span class="title">nl_pid_hash</span> &#123;</span></span><br><span class="line"> <span class="number">107</span>         <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> *<span class="title">table</span>;</span></span><br><span class="line"> <span class="number">108</span>         <span class="type">unsigned</span> <span class="type">long</span> rehash_time;</span><br><span class="line"> <span class="number">109</span></span><br><span class="line"> <span class="number">110</span>         <span class="type">unsigned</span> <span class="type">int</span> mask;</span><br><span class="line"> <span class="number">111</span>         <span class="type">unsigned</span> <span class="type">int</span> shift;</span><br><span class="line"> <span class="number">112</span></span><br><span class="line"> <span class="number">113</span>         <span class="type">unsigned</span> <span class="type">int</span> entries;</span><br><span class="line"> <span class="number">114</span>         <span class="type">unsigned</span> <span class="type">int</span> max_shift;</span><br><span class="line"> <span class="number">115</span></span><br><span class="line"> <span class="number">116</span>         u32 rnd;</span><br><span class="line"> <span class="number">117</span> &#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">55</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtnl_link</span> &#123;</span></span><br><span class="line"><span class="number">56</span>         rtnl_doit_func          doit;</span><br><span class="line"><span class="number">57</span>         rtnl_dumpit_func        dumpit;</span><br><span class="line"><span class="number">58</span>         rtnl_calcit_func        calcit;</span><br><span class="line"><span class="number">59</span> &#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">101 static struct rtnl_link *rtnl_msg_handlers[RTNL_FAMILY_MAX + 1];</span><br></pre></td></tr></table></figure>

<p>###pernet ops</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2124 static struct pernet_operations __net_initdata netlink_net_ops = &#123;</span><br><span class="line">2125         .init = netlink_net_init,</span><br><span class="line">2126         .exit = netlink_net_exit,</span><br><span class="line">2127 &#125;;</span><br></pre></td></tr></table></figure>
<p>###socket related ops</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">396 static struct proto netlink_proto = &#123;</span><br><span class="line">397         .name     = &quot;NETLINK&quot;,</span><br><span class="line">398         .owner    = THIS_MODULE,</span><br><span class="line">399         .obj_size = sizeof(struct netlink_sock),</span><br><span class="line">400 &#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">2061 static const struct proto_ops netlink_ops = &#123;</span><br><span class="line">2062         .family =       PF_NETLINK,</span><br><span class="line">2063         .owner =        THIS_MODULE,</span><br><span class="line">2064         .release =      netlink_release,</span><br><span class="line">2065         .bind =         netlink_bind,</span><br><span class="line">2066         .connect =      netlink_connect,</span><br><span class="line">2067         .socketpair =   sock_no_socketpair,</span><br><span class="line">2068         .accept =       sock_no_accept,</span><br><span class="line">2069         .getname =      netlink_getname,</span><br><span class="line">2070         .poll =         datagram_poll,</span><br><span class="line">2071         .ioctl =        sock_no_ioctl,</span><br><span class="line">2072         .listen =       sock_no_listen,</span><br><span class="line">2073         .shutdown =     sock_no_shutdown,</span><br><span class="line">2074         .setsockopt =   netlink_setsockopt,</span><br><span class="line">2075         .getsockopt =   netlink_getsockopt,</span><br><span class="line">2076         .sendmsg =      netlink_sendmsg,</span><br><span class="line">2077         .recvmsg =      netlink_recvmsg,</span><br><span class="line">2078         .mmap =         sock_no_mmap,</span><br><span class="line">2079         .sendpage =     sock_no_sendpage,</span><br><span class="line">2080 &#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2082 static const struct net_proto_family netlink_family_ops = &#123;</span><br><span class="line">2083         .family = PF_NETLINK,</span><br><span class="line">2084         .create = netlink_create,</span><br><span class="line">2085         .owner  = THIS_MODULE,  /* for consistency 8) */</span><br><span class="line">2086 &#125;;</span><br></pre></td></tr></table></figure>
<p>###Initialization</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2129</span> <span class="type">static</span> <span class="type">int</span> __init <span class="title function_">netlink_proto_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">2130 &#123;</span><br><span class="line"><span class="number">2131</span>         <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">dummy_skb</span>;</span></span><br><span class="line"><span class="number">2132</span>         <span class="type">int</span> i;</span><br><span class="line"><span class="number">2133</span>         <span class="type">unsigned</span> <span class="type">long</span> limit;</span><br><span class="line"><span class="number">2134</span>         <span class="type">unsigned</span> <span class="type">int</span> order;</span><br><span class="line"><span class="number">2135</span>         <span class="type">int</span> err = proto_register(&amp;netlink_proto, <span class="number">0</span>);</span><br><span class="line"><span class="number">2136</span></span><br><span class="line"><span class="number">2137</span>         <span class="keyword">if</span> (err != <span class="number">0</span>)</span><br><span class="line"><span class="number">2138</span>                 <span class="keyword">goto</span> out;</span><br><span class="line"><span class="number">2139</span></span><br><span class="line"><span class="number">2140</span>         BUILD_BUG_ON(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> netlink_skb_parms) &gt; <span class="keyword">sizeof</span>(dummy_skb-&gt;cb));</span><br><span class="line"><span class="number">2141</span></span><br><span class="line"><span class="number">2142</span>         nl_table = kcalloc(MAX_LINKS, <span class="keyword">sizeof</span>(*nl_table), GFP_KERNEL);</span><br><span class="line"><span class="number">2143</span>         <span class="keyword">if</span> (!nl_table)</span><br><span class="line"><span class="number">2144</span>                 <span class="keyword">goto</span> panic;</span><br><span class="line"><span class="number">2145</span></span><br><span class="line"><span class="number">2146</span>         <span class="keyword">if</span> (totalram_pages &gt;= (<span class="number">128</span> * <span class="number">1024</span>))</span><br><span class="line"><span class="number">2147</span>                 limit = totalram_pages &gt;&gt; (<span class="number">21</span> - PAGE_SHIFT);</span><br><span class="line"><span class="number">2148</span>         <span class="keyword">else</span></span><br><span class="line"><span class="number">2149</span>                 limit = totalram_pages &gt;&gt; (<span class="number">23</span> - PAGE_SHIFT);</span><br><span class="line"><span class="number">2150</span></span><br><span class="line"><span class="number">2151</span>         order = get_bitmask_order(limit) - <span class="number">1</span> + PAGE_SHIFT;</span><br><span class="line"><span class="number">2152</span>         limit = (<span class="number">1UL</span> &lt;&lt; order) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> hlist_head);</span><br><span class="line"><span class="number">2153</span>         order = get_bitmask_order(min(limit, (<span class="type">unsigned</span> <span class="type">long</span>)UINT_MAX)) - <span class="number">1</span>;</span><br><span class="line"><span class="number">2154</span></span><br><span class="line"><span class="number">2155</span>         <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_LINKS; i++) &#123;</span><br><span class="line"><span class="number">2156</span>                 <span class="class"><span class="keyword">struct</span> <span class="title">nl_pid_hash</span> *<span class="title">hash</span> =</span> &amp;nl_table[i].hash;</span><br><span class="line"><span class="number">2157</span></span><br><span class="line"><span class="number">2158</span>                 hash-&gt;table = nl_pid_hash_zalloc(<span class="number">1</span> * <span class="keyword">sizeof</span>(*hash-&gt;table));</span><br><span class="line"><span class="number">2159</span>                 <span class="keyword">if</span> (!hash-&gt;table) &#123;</span><br><span class="line"><span class="number">2160</span>                         <span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line"><span class="number">2161</span>                                 nl_pid_hash_free(nl_table[i].hash.table,</span><br><span class="line"><span class="number">2162</span>                                                  <span class="number">1</span> * <span class="keyword">sizeof</span>(*hash-&gt;table));</span><br><span class="line"><span class="number">2163</span>                         kfree(nl_table);</span><br><span class="line"><span class="number">2164</span>                         <span class="keyword">goto</span> panic;</span><br><span class="line"><span class="number">2165</span>                 &#125;</span><br><span class="line"><span class="number">2166</span>                 hash-&gt;max_shift = order;</span><br><span class="line"><span class="number">2167</span>                 hash-&gt;shift = <span class="number">0</span>;</span><br><span class="line"><span class="number">2168</span>                 hash-&gt;mask = <span class="number">0</span>;</span><br><span class="line"><span class="number">2169</span>                 hash-&gt;rehash_time = jiffies;</span><br><span class="line"><span class="number">2170</span>         &#125;</span><br><span class="line"><span class="number">2171</span></span><br><span class="line"><span class="number">2172</span>         netlink_add_usersock_entry();</span><br><span class="line"><span class="number">2173</span></span><br><span class="line"><span class="number">2174</span>         sock_register(&amp;netlink_family_ops);</span><br><span class="line"><span class="number">2175</span>         register_pernet_subsys(&amp;netlink_net_ops);</span><br><span class="line"><span class="number">2176</span>         <span class="comment">/* The netlink device handler may be needed early. */</span></span><br><span class="line"><span class="number">2177</span>         rtnetlink_init();</span><br><span class="line"><span class="number">2178</span> out:</span><br><span class="line"><span class="number">2179</span>         <span class="keyword">return</span> err;</span><br><span class="line"><span class="number">2180</span> panic:</span><br><span class="line"><span class="number">2181</span>         panic(<span class="string">&quot;netlink_init: Cannot allocate nl_table\n&quot;</span>);</span><br><span class="line"><span class="number">2182</span> &#125;</span><br><span class="line"><span class="number">2183</span></span><br><span class="line"><span class="number">2184</span> core_initcall(netlink_proto_init);</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://martinbj2008.github.io/2013/02/16/2013-02-16-netlink-in-kernel/" data-id="clnfhaslg0014e0mhh092fdov" data-title="Netlink in kernel" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/netlink/" rel="tag">netlink</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2013/03/07/2013-03-07-netlink-bulk-dump/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          netlink bulk dump
        
      </div>
    </a>
  
  
    <a href="/2013/02/16/2013-02-16-socket-framework/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Socket Basic Framework</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IPv6/">IPv6</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bpf/">bpf</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/debug/">debug</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/gcc/">gcc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/irq/">irq</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/memory/">memory</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/neighbour/">neighbour</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/netdev/">netdev</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/netlink/">netlink</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/others/">others</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/route/">route</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/sched/">sched</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/socket/">socket</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vim/">vim</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/xfrm/">xfrm</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/IPv4/" rel="tag">IPv4</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IPv6/" rel="tag">IPv6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TODO/" rel="tag">TODO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/address/" rel="tag">address</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bh/" rel="tag">bh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bpf/" rel="tag">bpf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/checksum/" rel="tag">checksum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/" rel="tag">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/epoll/" rel="tag">epoll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gcc/" rel="tag">gcc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ipv6/" rel="tag">ipv6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/irq/" rel="tag">irq</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memory/" rel="tag">memory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/namespace/" rel="tag">namespace</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/neighbour/" rel="tag">neighbour</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netdev/" rel="tag">netdev</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netlink/" rel="tag">netlink</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/others/" rel="tag">others</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ovs/" rel="tag">ovs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/route/" rel="tag">route</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sched/" rel="tag">sched</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/" rel="tag">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket-tcp/" rel="tag">socket, tcp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcp/" rel="tag">tcp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcpdump/" rel="tag">tcpdump</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/" rel="tag">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xdp/" rel="tag">xdp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xfrm/" rel="tag">xfrm</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/IPv4/" style="font-size: 20px;">IPv4</a> <a href="/tags/IPv6/" style="font-size: 10.83px;">IPv6</a> <a href="/tags/TODO/" style="font-size: 10px;">TODO</a> <a href="/tags/address/" style="font-size: 14.17px;">address</a> <a href="/tags/bh/" style="font-size: 14.17px;">bh</a> <a href="/tags/bpf/" style="font-size: 16.67px;">bpf</a> <a href="/tags/checksum/" style="font-size: 10.83px;">checksum</a> <a href="/tags/debug/" style="font-size: 11.67px;">debug</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/gcc/" style="font-size: 14.17px;">gcc</a> <a href="/tags/git/" style="font-size: 12.5px;">git</a> <a href="/tags/ipv6/" style="font-size: 10.83px;">ipv6</a> <a href="/tags/irq/" style="font-size: 17.5px;">irq</a> <a href="/tags/memory/" style="font-size: 13.33px;">memory</a> <a href="/tags/namespace/" style="font-size: 10px;">namespace</a> <a href="/tags/neighbour/" style="font-size: 10px;">neighbour</a> <a href="/tags/netdev/" style="font-size: 18.33px;">netdev</a> <a href="/tags/netlink/" style="font-size: 13.33px;">netlink</a> <a href="/tags/others/" style="font-size: 10.83px;">others</a> <a href="/tags/ovs/" style="font-size: 10px;">ovs</a> <a href="/tags/route/" style="font-size: 18.33px;">route</a> <a href="/tags/sched/" style="font-size: 14.17px;">sched</a> <a href="/tags/socket/" style="font-size: 19.17px;">socket</a> <a href="/tags/socket-tcp/" style="font-size: 10px;">socket, tcp</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/tcpdump/" style="font-size: 15.83px;">tcpdump</a> <a href="/tags/vim/" style="font-size: 11.67px;">vim</a> <a href="/tags/xdp/" style="font-size: 10.83px;">xdp</a> <a href="/tags/xfrm/" style="font-size: 15px;">xfrm</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">February 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">January 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">November 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">October 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">September 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">August 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">August 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">June 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">May 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/02/">February 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10/">October 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/09/">September 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/04/">April 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/01/">January 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/06/">June 2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/05/">May 2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/12/">December 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/11/">November 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/10/">October 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/09/">September 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/08/">August 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/07/">July 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/06/">June 2007</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/06/23/tcpdump-and-PROMISC-state-label/">tcpdump命令与网口`PROMISC`状态标志位</a>
          </li>
        
          <li>
            <a href="/2025/05/07/tcp-paws-check/">PAWS 在tcp协议栈中的实现</a>
          </li>
        
          <li>
            <a href="/2025/05/06/how-tcp-server-accept-a-new-connection-request/">tcp三次握手 --- 逐渐消失的tcp半链接队列</a>
          </li>
        
          <li>
            <a href="/2025/05/05/tcp-req-queue-length-check/">创建req scoket时的三个长度检查</a>
          </li>
        
          <li>
            <a href="/2025/05/03/netdev-state-flags-part2/">网口状态标志位解析part2: 内核如何维护网卡carrier的状态</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 Martinbj2008<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>