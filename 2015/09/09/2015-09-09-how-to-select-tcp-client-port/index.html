<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>How to select tcp client port | Kernel Study Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1upstream source v4.2+(commit ID:a794b4f).  key vartcp_death_row197 struct inet_hashinfo tcp_hashinfo; callback123456789&gt; connect syscall&gt; &gt; sock-&gt;ops-&gt;connect&gt; &gt; &#x3D;&#x3D;&gt; tcp_v4_co">
<meta property="og:type" content="article">
<meta property="og:title" content="How to select tcp client port">
<meta property="og:url" content="https://martinbj2008.github.io/2015/09/09/2015-09-09-how-to-select-tcp-client-port/index.html">
<meta property="og:site_name" content="Kernel Study Notes">
<meta property="og:description" content="1upstream source v4.2+(commit ID:a794b4f).  key vartcp_death_row197 struct inet_hashinfo tcp_hashinfo; callback123456789&gt; connect syscall&gt; &gt; sock-&gt;ops-&gt;connect&gt; &gt; &#x3D;&#x3D;&gt; tcp_v4_co">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2015-09-09T08:42:00.000Z">
<meta property="article:modified_time" content="2023-10-07T03:29:55.082Z">
<meta property="article:author" content="Martinbj2008">
<meta property="article:tag" content="socket">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Kernel Study Notes" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Kernel Study Notes</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://martinbj2008.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-2015-09-09-how-to-select-tcp-client-port" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2015/09/09/2015-09-09-how-to-select-tcp-client-port/" class="article-date">
  <time class="dt-published" datetime="2015-09-09T08:42:00.000Z" itemprop="datePublished">2015-09-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/socket/">socket</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      How to select tcp client port
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upstream source v4.2+(commit ID:a794b4f).</span><br></pre></td></tr></table></figure>

<h4 id="key-var"><a href="#key-var" class="headerlink" title="key var"></a>key var</h4><h5 id="tcp-death-row"><a href="#tcp-death-row" class="headerlink" title="tcp_death_row"></a>tcp_death_row</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">97 struct inet_hashinfo tcp_hashinfo;</span><br></pre></td></tr></table></figure>
<h4 id="callback"><a href="#callback" class="headerlink" title="callback"></a>callback</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; connect syscall</span><br><span class="line">&gt; &gt; sock-&gt;ops-&gt;connect</span><br><span class="line">&gt; &gt; ==&gt; tcp_v4_connect</span><br><span class="line">&gt; &gt; &gt; inet_hash_connect</span><br><span class="line">&gt; &gt; &gt; &gt; port_offset = inet_sk_port_offset(sk);</span><br><span class="line">&gt; &gt; &gt; &gt; __inet_hash_connect</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; inet_get_local_port_range</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; for each port in range: start with port_offset.</span><br><span class="line">&gt; &gt; &gt; &gt; &gt; &gt; inet_is_local_reserved_port //skip the reserved ports.</span><br></pre></td></tr></table></figure>

<p>There is a important data struct <code>struct inet_hashinfo</code><br>其对应的变量是 <code>tcp_hashinfo</code>.</p>
<p>共包含3部分:</p>
<ol>
<li>ehash: establish hash. netnamspace，saddr, daddr, sport, dport. 每个struct sock, 通过&amp;sk-&gt;sk_nulls_node，挂接到hash链上.</li>
<li>bhash: 使用netnamespace和localport作为key。<br> hashlist节点是struct inet_bind_bucket，通过其node域链接到hash链上。<br> 一个节点对应一个local port。 节点下又一个owner 链。num_owners表示owner链的长度。<br> 每个struct sock,通过sk-&gt;sk_bind_node，链接到owner链上。</li>
<li>listening_hash: 待后续完善。tcp server使用。</li>
</ol>
<span id="more"></span>

<h3 id="related-source"><a href="#related-source" class="headerlink" title="related source"></a>related source</h3><h4 id="data-struct"><a href="#data-struct" class="headerlink" title="data struct"></a>data struct</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">34 struct inet_timewait_death_row &#123;</span><br><span class="line">35         atomic_t                tw_count;</span><br><span class="line">36</span><br><span class="line">37         struct inet_hashinfo    *hashinfo ____cacheline_aligned_in_smp;</span><br><span class="line">38         int                     sysctl_tw_recycle;</span><br><span class="line">39         int                     sysctl_max_tw_buckets;</span><br><span class="line">40 &#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">116 struct inet_hashinfo &#123;</span><br><span class="line">117         /* This is for sockets with full identity only.  Sockets here will</span><br><span class="line">118          * always be without wildcards and will have the following invariant:</span><br><span class="line">119          *</span><br><span class="line">120          *          TCP_ESTABLISHED &lt;= sk-&gt;sk_state &lt; TCP_CLOSE</span><br><span class="line">121          *</span><br><span class="line">122          */</span><br><span class="line">123         struct inet_ehash_bucket        *ehash;</span><br><span class="line">124         spinlock_t                      *ehash_locks;</span><br><span class="line">125         unsigned int                    ehash_mask;</span><br><span class="line">126         unsigned int                    ehash_locks_mask;</span><br><span class="line">127</span><br><span class="line">128         /* Ok, let&#x27;s try this, I give up, we do need a local binding</span><br><span class="line">129          * TCP hash as well as the others for fast bind/connect.</span><br><span class="line">130          */</span><br><span class="line">131         struct inet_bind_hashbucket     *bhash;</span><br><span class="line">132</span><br><span class="line">133         unsigned int                    bhash_size;</span><br><span class="line">134         /* 4 bytes hole on 64 bit */</span><br><span class="line">135</span><br><span class="line">136         struct kmem_cache               *bind_bucket_cachep;</span><br><span class="line">137</span><br><span class="line">138         /* All the above members are written once at bootup and</span><br><span class="line">139          * never written again _or_ are predominantly read-access.</span><br><span class="line">140          *</span><br><span class="line">141          * Now align to a new cache line as all the following members</span><br><span class="line">142          * might be often dirty.</span><br><span class="line">143          */</span><br><span class="line">144         /* All sockets in TCP_LISTEN state will be in here.  This is the only</span><br><span class="line">145          * table where wildcard&#x27;d TCP sockets can exist.  Hash function here</span><br><span class="line">146          * is just local port number.</span><br><span class="line">147          */</span><br><span class="line">148         struct inet_listen_hashbucket   listening_hash[INET_LHTABLE_SIZE]</span><br><span class="line">149                                         ____cacheline_aligned_in_smp;</span><br><span class="line">150 &#125;;</span><br></pre></td></tr></table></figure>

<h5 id="system-call-connect"><a href="#system-call-connect" class="headerlink" title="system call connect"></a>system call connect</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(connect, int, fd, struct sockaddr __user *, uservaddr,</span><br><span class="line">                int, addrlen)</span><br><span class="line">&#123;</span><br><span class="line"> ...</span><br><span class="line">        err = sock-&gt;ops-&gt;connect(sock, (struct sockaddr *)&amp;address, addrlen,</span><br><span class="line">                                 sock-&gt;file-&gt;f_flags);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id=""><a href="#" class="headerlink" title=""></a></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> 140 /* This will initiate an outgoing connection. */</span><br><span class="line"> 141 int tcp_v4_connect(struct sock *sk, struct sockaddr *uaddr, int addr_len)</span><br><span class="line"> 142 &#123;</span><br><span class="line">...</span><br><span class="line"> 215         /* Socket identity is still unknown (sport may be zero).</span><br><span class="line"> 216          * However we set state to SYN-SENT and not releasing socket</span><br><span class="line"> 217          * lock select source port, enter ourselves into the hash tables and</span><br><span class="line"> 218          * complete initialization after this.</span><br><span class="line"> 219          */</span><br><span class="line"> 220         tcp_set_state(sk, TCP_SYN_SENT);</span><br><span class="line"> 221         err = inet_hash_connect(&amp;tcp_death_row, sk);</span><br><span class="line"> 222         if (err)</span><br><span class="line"> 223                 goto failure;</span><br><span class="line">...</span><br><span class="line"> 264 &#125;</span><br><span class="line"> 265 EXPORT_SYMBOL(tcp_v4_connect);</span><br></pre></td></tr></table></figure>

<h5 id="-1"><a href="#-1" class="headerlink" title=""></a></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">584 /*</span><br><span class="line">585  * Bind a port for a connect operation and hash it.</span><br><span class="line">586  */</span><br><span class="line">587 int inet_hash_connect(struct inet_timewait_death_row *death_row,</span><br><span class="line">588                       struct sock *sk)</span><br><span class="line">589 &#123;</span><br><span class="line">590         u32 port_offset = 0;</span><br><span class="line">591</span><br><span class="line">592         if (!inet_sk(sk)-&gt;inet_num)</span><br><span class="line">593                 port_offset = inet_sk_port_offset(sk);</span><br><span class="line">594         return __inet_hash_connect(death_row, sk, port_offset,</span><br><span class="line">595                                    __inet_check_established);</span><br><span class="line">596 &#125;</span><br><span class="line">597 EXPORT_SYMBOL_GPL(inet_hash_connect);</span><br></pre></td></tr></table></figure>


<h5 id="inet-hash-connect"><a href="#inet-hash-connect" class="headerlink" title="__inet_hash_connect"></a><code>__inet_hash_connect</code></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">a. 为了安全性，选区一个随机的端口偏移。</span><br><span class="line">b. 首先根据inet_get_local_port_range获得本机tcp端口的合法范围。</span><br><span class="line">c. 从随机偏移的端口开始，便利所有的port</span><br><span class="line">	for each port in ragne </span><br><span class="line">	c.1 判断端口是否为保留的端口。 inet_is_local_reserved_port</span><br><span class="line">		c.1.1 如果是保留节点，下一个节点</span><br><span class="line">	c.2 	根据netnamespace和port计算hash值，并去对应的bhash桶的头。</span><br><span class="line">	c.3 	便利bhash链上对应的每个节点。</span><br><span class="line">		c.3.1 比较每个节点的(port和netnamespace) vs 当前的port和netnamespace</span><br><span class="line">		c.3.2 如果不相等，下一个节点，否则检查是否为check_established</span><br><span class="line">		c.3.2 否则检查是否为check_established</span><br><span class="line">			c.3.2.1 如果检查失败，下一个节点</span><br><span class="line">			c.3.2.2 ture goto OK</span><br><span class="line">	c.4	遍历玩bhash节点，未发现该netnamespace下的port被占用。</span><br><span class="line">		调用inet_bind_bucket_create，占用该netnamespace下的port</span><br><span class="line">		goto OK;</span><br><span class="line">d. 遍历完成，没有合适的节点。 return -EADDRNOTAVAIL;</span><br><span class="line"></span><br><span class="line">OK：</span><br><span class="line">	找到合适的port。更新ehash和bhash</span><br><span class="line">	inet_bind_hash(sk, tb, port);</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">476 int __inet_hash_connect(struct inet_timewait_death_row *death_row,</span><br><span class="line">477                 struct sock *sk, u32 port_offset,</span><br><span class="line">478                 int (*check_established)(struct inet_timewait_death_row *,</span><br><span class="line">479                         struct sock *, __u16, struct inet_timewait_sock **))</span><br><span class="line">480 &#123;</span><br><span class="line">481         struct inet_hashinfo *hinfo = death_row-&gt;hashinfo;</span><br><span class="line">482         const unsigned short snum = inet_sk(sk)-&gt;inet_num;</span><br><span class="line">483         struct inet_bind_hashbucket *head;</span><br><span class="line">484         struct inet_bind_bucket *tb;</span><br><span class="line">485         int ret;</span><br><span class="line">486         struct net *net = sock_net(sk);</span><br><span class="line">487</span><br><span class="line">488         if (!snum) &#123;</span><br><span class="line">489                 int i, remaining, low, high, port;</span><br><span class="line">490                 static u32 hint;</span><br><span class="line">491                 u32 offset = hint + port_offset;</span><br><span class="line">492                 struct inet_timewait_sock *tw = NULL;</span><br><span class="line">493</span><br><span class="line">494                 inet_get_local_port_range(net, &amp;low, &amp;high);</span><br><span class="line">495                 remaining = (high - low) + 1;</span><br><span class="line">496</span><br><span class="line">497                 /* By starting with offset being an even number,</span><br><span class="line">498                  * we tend to leave about 50% of ports for other uses,</span><br><span class="line">499                  * like bind(0).</span><br><span class="line">500                  */</span><br><span class="line">501                 offset &amp;= ~1;</span><br><span class="line">502</span><br><span class="line">503                 local_bh_disable();</span><br><span class="line">504                 for (i = 0; i &lt; remaining; i++) &#123;</span><br><span class="line">505                         port = low + (i + offset) % remaining;</span><br><span class="line">506                         if (inet_is_local_reserved_port(net, port))</span><br><span class="line">507                                 continue;</span><br><span class="line">508                         head = &amp;hinfo-&gt;bhash[inet_bhashfn(net, port,</span><br><span class="line">509                                         hinfo-&gt;bhash_size)];</span><br><span class="line">510                         spin_lock(&amp;head-&gt;lock);</span><br><span class="line">511</span><br><span class="line">512                         /* Does not bother with rcv_saddr checks,</span><br><span class="line">513                          * because the established check is already</span><br><span class="line">514                          * unique enough.</span><br><span class="line">515                          */</span><br><span class="line">516                         inet_bind_bucket_for_each(tb, &amp;head-&gt;chain) &#123;</span><br><span class="line">517                                 if (net_eq(ib_net(tb), net) &amp;&amp;</span><br><span class="line">518                                     tb-&gt;port == port) &#123;</span><br><span class="line">519                                         if (tb-&gt;fastreuse &gt;= 0 ||</span><br><span class="line">520                                             tb-&gt;fastreuseport &gt;= 0)</span><br><span class="line">521                                                 goto next_port;</span><br><span class="line">522                                         WARN_ON(hlist_empty(&amp;tb-&gt;owners));</span><br><span class="line">523                                         if (!check_established(death_row, sk,</span><br><span class="line">524                                                                 port, &amp;tw))</span><br><span class="line">525                                                 goto ok;</span><br><span class="line">526                                         goto next_port;</span><br><span class="line">527                                 &#125;</span><br><span class="line">528                         &#125;</span><br><span class="line">529</span><br><span class="line">530                         tb = inet_bind_bucket_create(hinfo-&gt;bind_bucket_cachep,</span><br><span class="line">531                                         net, head, port);</span><br><span class="line">532                         if (!tb) &#123;</span><br><span class="line">533                                 spin_unlock(&amp;head-&gt;lock);</span><br><span class="line">534                                 break;</span><br><span class="line">535                         &#125;</span><br><span class="line">536                         tb-&gt;fastreuse = -1;</span><br><span class="line">537                         tb-&gt;fastreuseport = -1;</span><br><span class="line">538                         goto ok;</span><br><span class="line">539</span><br><span class="line">540                 next_port:</span><br><span class="line">541                         spin_unlock(&amp;head-&gt;lock);</span><br><span class="line">542                 &#125;</span><br><span class="line">543                 local_bh_enable();</span><br><span class="line">544</span><br><span class="line">545                 return -EADDRNOTAVAIL;</span><br><span class="line">546</span><br><span class="line">547 ok:</span><br><span class="line">548                 hint += (i + 2) &amp; ~1;</span><br><span class="line">549</span><br><span class="line">550                 /* Head lock still held and bh&#x27;s disabled */</span><br><span class="line">551                 inet_bind_hash(sk, tb, port);</span><br><span class="line">552                 if (sk_unhashed(sk)) &#123;</span><br><span class="line">553                         inet_sk(sk)-&gt;inet_sport = htons(port);</span><br><span class="line">554                         __inet_hash_nolisten(sk, (struct sock *)tw);</span><br><span class="line">555                 &#125;</span><br><span class="line">556                 if (tw)</span><br><span class="line">557                         inet_twsk_bind_unhash(tw, hinfo);</span><br><span class="line">558                 spin_unlock(&amp;head-&gt;lock);</span><br><span class="line">559</span><br><span class="line">560                 if (tw)</span><br><span class="line">561                         inet_twsk_deschedule_put(tw);</span><br><span class="line">562</span><br><span class="line">563                 ret = 0;</span><br><span class="line">564                 goto out;</span><br><span class="line">565         &#125;</span><br><span class="line">566</span><br><span class="line">567         head = &amp;hinfo-&gt;bhash[inet_bhashfn(net, snum, hinfo-&gt;bhash_size)];</span><br><span class="line">568         tb  = inet_csk(sk)-&gt;icsk_bind_hash;</span><br><span class="line">569         spin_lock_bh(&amp;head-&gt;lock);</span><br><span class="line">570         if (sk_head(&amp;tb-&gt;owners) == sk &amp;&amp; !sk-&gt;sk_bind_node.next) &#123;</span><br><span class="line">571                 __inet_hash_nolisten(sk, NULL);</span><br><span class="line">572                 spin_unlock_bh(&amp;head-&gt;lock);</span><br><span class="line">573                 return 0;</span><br><span class="line">574         &#125; else &#123;</span><br><span class="line">575                 spin_unlock(&amp;head-&gt;lock);</span><br><span class="line">576                 /* No definite answer... Walk to established hash table */</span><br><span class="line">577                 ret = check_established(death_row, sk, snum, NULL);</span><br><span class="line">578 out:</span><br><span class="line">579                 local_bh_enable();</span><br><span class="line">580                 return ret;</span><br><span class="line">581         &#125;</span><br><span class="line">582 &#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">326 /* called with local bh disabled */</span><br><span class="line">327 static int __inet_check_established(struct inet_timewait_death_row *death_row,</span><br><span class="line">328                                     struct sock *sk, __u16 lport,</span><br><span class="line">329                                     struct inet_timewait_sock **twp)</span><br><span class="line">330 &#123;</span><br><span class="line">331         struct inet_hashinfo *hinfo = death_row-&gt;hashinfo;</span><br><span class="line">332         struct inet_sock *inet = inet_sk(sk);</span><br><span class="line">333         __be32 daddr = inet-&gt;inet_rcv_saddr;</span><br><span class="line">334         __be32 saddr = inet-&gt;inet_daddr;</span><br><span class="line">335         int dif = sk-&gt;sk_bound_dev_if;</span><br><span class="line">336         INET_ADDR_COOKIE(acookie, saddr, daddr);</span><br><span class="line">337         const __portpair ports = INET_COMBINED_PORTS(inet-&gt;inet_dport, lport);</span><br><span class="line">338         struct net *net = sock_net(sk);</span><br><span class="line">339         unsigned int hash = inet_ehashfn(net, daddr, lport,</span><br><span class="line">340                                          saddr, inet-&gt;inet_dport);</span><br><span class="line">341         struct inet_ehash_bucket *head = inet_ehash_bucket(hinfo, hash);</span><br><span class="line">342         spinlock_t *lock = inet_ehash_lockp(hinfo, hash);</span><br><span class="line">343         struct sock *sk2;</span><br><span class="line">344         const struct hlist_nulls_node *node;</span><br><span class="line">345         struct inet_timewait_sock *tw = NULL;</span><br><span class="line">346</span><br><span class="line">347         spin_lock(lock);</span><br><span class="line">348</span><br><span class="line">349         sk_nulls_for_each(sk2, node, &amp;head-&gt;chain) &#123;</span><br><span class="line">350                 if (sk2-&gt;sk_hash != hash)</span><br><span class="line">351                         continue;</span><br><span class="line">352</span><br><span class="line">353                 if (likely(INET_MATCH(sk2, net, acookie,</span><br><span class="line">354                                          saddr, daddr, ports, dif))) &#123;</span><br><span class="line">355                         if (sk2-&gt;sk_state == TCP_TIME_WAIT) &#123;</span><br><span class="line">356                                 tw = inet_twsk(sk2);</span><br><span class="line">357                                 if (twsk_unique(sk, sk2, twp))</span><br><span class="line">358                                         break;</span><br><span class="line">359                         &#125;</span><br><span class="line">360                         goto not_unique;</span><br><span class="line">361                 &#125;</span><br><span class="line">362         &#125;</span><br><span class="line">363</span><br><span class="line">364         /* Must record num and sport now. Otherwise we will see</span><br><span class="line">365          * in hash table socket with a funny identity.</span><br><span class="line">366          */</span><br><span class="line">367         inet-&gt;inet_num = lport;</span><br><span class="line">368         inet-&gt;inet_sport = htons(lport);</span><br><span class="line">369         sk-&gt;sk_hash = hash;</span><br><span class="line">370         WARN_ON(!sk_unhashed(sk));</span><br><span class="line">371         __sk_nulls_add_node_rcu(sk, &amp;head-&gt;chain);</span><br><span class="line">372         if (tw) &#123;</span><br><span class="line">373                 sk_nulls_del_node_init_rcu((struct sock *)tw);</span><br><span class="line">374                 NET_INC_STATS_BH(net, LINUX_MIB_TIMEWAITRECYCLED);</span><br><span class="line">375         &#125;</span><br><span class="line">376         spin_unlock(lock);</span><br><span class="line">377         sock_prot_inuse_add(sock_net(sk), sk-&gt;sk_prot, 1);</span><br><span class="line">378</span><br><span class="line">379         if (twp) &#123;</span><br><span class="line">380                 *twp = tw;</span><br><span class="line">381         &#125; else if (tw) &#123;</span><br><span class="line">382                 /* Silly. Should hash-dance instead... */</span><br><span class="line">383                 inet_twsk_deschedule_put(tw);</span><br><span class="line">384         &#125;</span><br><span class="line">385         return 0;</span><br><span class="line">386</span><br><span class="line">387 not_unique:</span><br><span class="line">388         spin_unlock(lock);</span><br><span class="line">389         return -EADDRNOTAVAIL;</span><br><span class="line">390 &#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://martinbj2008.github.io/2015/09/09/2015-09-09-how-to-select-tcp-client-port/" data-id="clnfhasom005se0mh2r8w8cvl" data-title="How to select tcp client port" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/socket/" rel="tag">socket</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/09/11/2015-09-11-basic-data-structure-of-inet-socket-inetsw/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          basic data structure of inet socket: inetsw
        
      </div>
    </a>
  
  
    <a href="/2015/06/26/2015-06-26-xen-tcp-checksum-for-back-and-front-net-driver/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">xen tcp checksum for back and front net driver</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IPv6/">IPv6</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bpf/">bpf</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/debug/">debug</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/gcc/">gcc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/irq/">irq</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/memory/">memory</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/neighbour/">neighbour</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/netdev/">netdev</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/netlink/">netlink</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/others/">others</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/route/">route</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/sched/">sched</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/socket/">socket</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vim/">vim</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/xfrm/">xfrm</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/IPv4/" rel="tag">IPv4</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IPv6/" rel="tag">IPv6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TODO/" rel="tag">TODO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/address/" rel="tag">address</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bh/" rel="tag">bh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bpf/" rel="tag">bpf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/checksum/" rel="tag">checksum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/" rel="tag">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/epoll/" rel="tag">epoll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gcc/" rel="tag">gcc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ipv6/" rel="tag">ipv6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/irq/" rel="tag">irq</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memory/" rel="tag">memory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/namespace/" rel="tag">namespace</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/neighbour/" rel="tag">neighbour</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netdev/" rel="tag">netdev</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netlink/" rel="tag">netlink</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/others/" rel="tag">others</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ovs/" rel="tag">ovs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/route/" rel="tag">route</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sched/" rel="tag">sched</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/" rel="tag">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket-tcp/" rel="tag">socket, tcp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcp/" rel="tag">tcp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcpdump/" rel="tag">tcpdump</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/" rel="tag">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xdp/" rel="tag">xdp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xfrm/" rel="tag">xfrm</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/IPv4/" style="font-size: 20px;">IPv4</a> <a href="/tags/IPv6/" style="font-size: 10.83px;">IPv6</a> <a href="/tags/TODO/" style="font-size: 10px;">TODO</a> <a href="/tags/address/" style="font-size: 14.17px;">address</a> <a href="/tags/bh/" style="font-size: 14.17px;">bh</a> <a href="/tags/bpf/" style="font-size: 16.67px;">bpf</a> <a href="/tags/checksum/" style="font-size: 10.83px;">checksum</a> <a href="/tags/debug/" style="font-size: 11.67px;">debug</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/gcc/" style="font-size: 14.17px;">gcc</a> <a href="/tags/git/" style="font-size: 12.5px;">git</a> <a href="/tags/ipv6/" style="font-size: 10.83px;">ipv6</a> <a href="/tags/irq/" style="font-size: 17.5px;">irq</a> <a href="/tags/memory/" style="font-size: 13.33px;">memory</a> <a href="/tags/namespace/" style="font-size: 10px;">namespace</a> <a href="/tags/neighbour/" style="font-size: 10px;">neighbour</a> <a href="/tags/netdev/" style="font-size: 18.33px;">netdev</a> <a href="/tags/netlink/" style="font-size: 13.33px;">netlink</a> <a href="/tags/others/" style="font-size: 10.83px;">others</a> <a href="/tags/ovs/" style="font-size: 10px;">ovs</a> <a href="/tags/route/" style="font-size: 18.33px;">route</a> <a href="/tags/sched/" style="font-size: 14.17px;">sched</a> <a href="/tags/socket/" style="font-size: 19.17px;">socket</a> <a href="/tags/socket-tcp/" style="font-size: 10px;">socket, tcp</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/tcpdump/" style="font-size: 15.83px;">tcpdump</a> <a href="/tags/vim/" style="font-size: 11.67px;">vim</a> <a href="/tags/xdp/" style="font-size: 10.83px;">xdp</a> <a href="/tags/xfrm/" style="font-size: 15px;">xfrm</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">February 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">January 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">November 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">October 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">September 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">August 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">August 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">June 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">May 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/02/">February 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10/">October 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/09/">September 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/04/">April 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/01/">January 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/06/">June 2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/05/">May 2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/12/">December 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/11/">November 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/10/">October 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/09/">September 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/08/">August 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/07/">July 2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/06/">June 2007</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/05/07/tcp-paws-check/">PAWS 在tcp协议栈中的实现</a>
          </li>
        
          <li>
            <a href="/2025/05/06/how-tcp-server-accept-a-new-connection-request/">tcp三次握手 --- 逐渐消失的tcp半链接队列</a>
          </li>
        
          <li>
            <a href="/2025/05/05/tcp-req-queue-length-check/">创建req scoket时的三个长度检查</a>
          </li>
        
          <li>
            <a href="/2025/05/03/netdev-state-flags-part2/">网口状态标志位解析part2: 内核如何维护网卡carrier的状态</a>
          </li>
        
          <li>
            <a href="/2025/05/01/netdev-state-flags-part1/">网口状态标志位详解(Part 1/2)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 Martinbj2008<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>