
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>My Octopress Blog</title>
  <meta name="author" content="Your Name">

  
  <meta name="description" content="test case We found ixgbe rx softirq poll function ixgbe_poll was called even without pkt coming.
how to prove it and who call it? analysis By browse &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://martinbj2008.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!-- link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css" -->
<!-- link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css" -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="martinbj2008.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/21/ftrace-study/">Ftrace Study</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-10-21T14:45:00+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span> <span class='time'>2:45 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>test case</h3>

<p>We found ixgbe  rx softirq  poll function <code>ixgbe_poll</code> was called even without pkt coming.
how to prove it and who call it?</p>

<h3>analysis</h3>

<p>By browse source <code>ixgbe_poll</code> is called, it should be done by napi schedule.
If this is true, <code>__napi_schedule</code> should be called.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2014/10/21/ftrace-study/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/17/netdevice-watchdog-cause-tx-queue-schedule/">Netdevice Watchdog Cause Tx Queue Schedule</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-09-17T15:38:00+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>3:38 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>test case</h3>

<p>For ixgbe nic, we want to assign a tx hardware qeueue to each cpu,
and the tx softirq should use the corresponding hardware queue.</p>

<p>each packet will select a softqueue in <code>dev_queue_xmit</code>,
we rewrite ixgbe driver <code>ndo_select_queue</code>(<code>ixgbe_select_queue</code>),
which will return current cpu index(based 0) when packet select queue.
thus for each cpu use its own tx queue.</p>

<p>but, we found some packet had unmatched queue index when send
on specific cpu.</p>

<p>for example, a packet&rsquo;s queue index is 5 but is sent by cpu3,
thus, cpu3 will operate tx hw queue5, which should only be done by cpu5.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2014/09/17/netdevice-watchdog-cause-tx-queue-schedule/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/16/ixgbe-queue-index/">How Does Ixgbe Use Queue Index</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-09-16T10:58:00+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:58 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>data structure</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>7913 static const struct net_device_ops ixgbe_netdev_ops = {
</span><span class='line'>...
</span><span class='line'>7916         .ndo_start_xmit         = ixgbe_xmit_frame,
</span><span class='line'>7917         .ndo_select_queue       = ixgbe_select_queue,
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h3>receive skb: record receive queue index</h3>

<p>record <code>queue_index +1</code>, 0 is used as NOT record.</p>

<h4>call trace</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; ixgbe_poll
</span><span class='line'>&gt; &gt; ixgbe_clean_rx_irq
</span><span class='line'>&gt; &gt; &gt; ixgbe_process_skb_fields
</span><span class='line'>&gt; &gt; &gt; &gt; skb_record_rx_queue</span></code></pre></td></tr></table></div></figure>




</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2014/09/16/ixgbe-queue-index/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/14/tcpdump-work-with-bonding-interface/">Tcpdump Work With Bonding Interface</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-09-14T08:12:00+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:12 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>test case</h3>

<h4>On redhat5, Why tcpdump could not work on bonding work.</h4>

<p>OS: redhat 5.
There are two 82599 interfaces eth0 and eth1.
These two interfaces are used as slave of bond0,
eth1 is backup of eth0.</p>

<p>We ping the default gateway on test machine.
ping work OK, and tcpdump on bond0 show the icmp request and icmp require packets.
while on eth0 only icmp request, and eth1 has no any packet.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2014/09/14/tcpdump-work-with-bonding-interface/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/31/how-to-select-source-ip-for-a-tcp-socket/">How to Select Source Ip for a Tcp Socket</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-31T09:06:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span> <span class='time'>9:06 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>#</h1>

<p>This question should be divided into two parts.</p>

<h3>Part 1: adding a route</h3>

<h4>Add a direct(link) route</h4>

<h4>Add a route with gateway</h4>

<h3>create a socket</h3>

<h4>for example &lsquo;connect&rsquo; system call</h4>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/17/register-irq-handler/">Register Irq Handler</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-17T11:41:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>11:41 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>call trace</h3>

<p>以<code>handle_level_irq</code>为例说明.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>===&gt; handle_level_irq
</span><span class='line'>==&gt; ==&gt; handle_irq_event
</span><span class='line'>==&gt; ==&gt; ==&gt; handle_irq_event_percpu
</span><span class='line'>==&gt; ==&gt; ==&gt; ==&gt;action-&gt;handler</span></code></pre></td></tr></table></div></figure>


<h4>where handler is registered</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>127 static inline int __must_check
</span><span class='line'>128 request_irq(unsigned int irq, irq_handler_t handler, unsigned long flags,
</span><span class='line'>129             const char *name, void *dev)
</span><span class='line'>130 {
</span><span class='line'>131         return request_threaded_irq(irq, handler, NULL, flags, name, dev);
</span><span class='line'>132 }</span></code></pre></td></tr></table></div></figure>


</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2014/07/17/register-irq-handler/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/17/irq-study/">Irq Vector</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-17T10:35:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:35 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>中断处理过程：</h3>

<p>reg value&ndash;>irq(int) &mdash;> struct irq_desc</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>==&gt; 中断时的有一个寄存器会保存中断源的vector值.
</span><span class='line'>==&gt; ==&gt; `arch/x86/kernel/entry_64.S`调用函数`do_IRQ`.
</span><span class='line'>==&gt; ==&gt; ==&gt; `do_IRQ`依据`vector_irq`和vector值, 找到对应的中断号,并调用`handle_irq`.
</span><span class='line'>==&gt; ==&gt; ==&gt; ==&gt; `handle_irq`通过函数irq_to_descdesc,可将中断号转化为`struct irq_desc`.
</span><span class='line'>==&gt; ==&gt; ==&gt; ==&gt; generic_handle_irq_desc(irq, desc);
</span><span class='line'>==&gt; ==&gt; ==&gt; ==&gt; ==&gt; `generic_handle_irq_desc`调用 desc-&gt;handle_irq(irq, desc);</span></code></pre></td></tr></table></div></figure>


<p>注:这里的handle_irq不是真正的中断处理函数,而是几大类中断控制器处理函数.
如82599, msi等.</p>

<h4>`do_IRQ(struct pt_regs *regs)</h4>

<p>File: arch/x86/kernel/irq.c</p>

<p>arch/x86/kernel/entry_64.S
will call do_IRQ</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2014/07/17/irq-study/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/17/irq-framework/">Irq Framework</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-17T10:35:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:35 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>中断处理过程：</h3>

<h4>硬件中断到中断控制器</h4>

<p>reg value&ndash;>irq(int) &mdash;> struct irq_desc</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>==&gt; 中断时的有一个寄存器会保存中断源的vector值.
</span><span class='line'>==&gt; ==&gt; `arch/x86/kernel/entry_64.S`调用函数`do_IRQ`.
</span><span class='line'>==&gt; ==&gt; ==&gt; `do_IRQ`依据`vector_irq`和vector值, 找到对应的中断号,并调用`handle_irq`.
</span><span class='line'>==&gt; ==&gt; ==&gt; ==&gt; `handle_irq`通过函数irq_to_descdesc,可将中断号转化为`struct irq_desc`.
</span><span class='line'>==&gt; ==&gt; ==&gt; ==&gt; generic_handle_irq_desc(irq, desc);
</span><span class='line'>==&gt; ==&gt; ==&gt; ==&gt; ==&gt; `generic_handle_irq_desc`调用 desc-&gt;handle_irq(irq, desc);</span></code></pre></td></tr></table></div></figure>


<p>注:这里的handle_irq不是真正的中断处理函数,而是几大类中断控制器处理函数.
如82599, msi等.
具体分析见:<a href="http://martinbj2008.github.io/blog/2014/07/17/irq-study">irq study1</a></p>

<h4>中断控制器到具体的中断处理函数</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>==&gt; handle_level_irq
</span><span class='line'>==&gt; ==&gt; irqreturn_t handle_irq_event(struct irq_desc *desc)
</span><span class='line'>==&gt; ==&gt; ==&gt; struct irqaction *action = desc-&gt;action
</span><span class='line'>==&gt; ==&gt; ==&gt; ret = handle_irq_event_percpu(desc, action);
</span><span class='line'>==&gt; ==&gt; ==&gt; ==&gt; action-&gt;handler(irq, action-&gt;dev_id);</span></code></pre></td></tr></table></div></figure>


<p>这里的<code>action-&gt;handler</code>才是我们使用<code>request_irq</code>注册的中断处理函数.
具体分析见:
具体分析见:<a href="http://martinbj2008.github.io/blog/2014/07/17/register-irq-handler">irq study2</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/18/dst-gc-work/">Delayed Work: Dst_gc_work</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-02-18T15:26:00+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>3:26 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>summary</h3>

<p>A delayed work will first start a timer,
and when timeout, the delayed work will be put a <code>worker_pool</code>&rsquo;s
<code>worklist</code> or a <code>pool_workqueue</code>&rsquo;s <code>delayed_works</code></p>

<h3>how to use delayed work</h3>

<h4>data structure</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mi">113</span> <span class="k">struct</span> <span class="n">delayed_work</span> <span class="p">{</span>
</span><span class='line'><span class="mi">114</span>         <span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
</span><span class='line'><span class="mi">115</span>         <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
</span><span class='line'><span class="mi">116</span>
</span><span class='line'><span class="mi">117</span>         <span class="cm">/* target workqueue and CPU -&gt;timer uses to queue -&gt;work */</span>
</span><span class='line'><span class="mi">118</span>         <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">wq</span><span class="p">;</span>
</span><span class='line'><span class="mi">119</span>         <span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
</span><span class='line'><span class="mi">120</span> <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2014/02/18/dst-gc-work/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/18/struct-worker-pool-%3Enr-running/">Struct Worker_pool->nr_running</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-02-18T15:15:00+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>3:15 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Defination</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="mi">141</span> <span class="cm">/* struct worker is defined in workqueue_internal.h */</span>
</span><span class='line'> <span class="mi">142</span>
</span><span class='line'> <span class="mi">143</span> <span class="k">struct</span> <span class="n">worker_pool</span> <span class="p">{</span>
</span><span class='line'> <span class="p">...</span>
</span><span class='line'> <span class="mi">173</span>         <span class="cm">/*</span>
</span><span class='line'><span class="cm"> 174          * The current concurrency level.  As it&#39;s likely to be accessed</span>
</span><span class='line'><span class="cm"> 175          * from other CPUs during try_to_wake_up(), put it in a separate</span>
</span><span class='line'><span class="cm"> 176          * cacheline.</span>
</span><span class='line'><span class="cm"> 177          */</span>
</span><span class='line'> <span class="mi">178</span>         <span class="kt">atomic_t</span>                <span class="n">nr_running</span> <span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Increase</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="mi">813</span> <span class="cm">/**</span>
</span><span class='line'><span class="cm"> 814  * wq_worker_waking_up - a worker is waking up</span>
</span><span class='line'><span class="cm"> 815  * @task: task waking up</span>
</span><span class='line'><span class="cm"> 816  * @cpu: CPU @task is waking up to</span>
</span><span class='line'><span class="cm"> 817  *</span>
</span><span class='line'><span class="cm"> 818  * This function is called during try_to_wake_up() when a worker is</span>
</span><span class='line'><span class="cm"> 819  * being awoken.</span>
</span><span class='line'><span class="cm"> 820  *</span>
</span><span class='line'><span class="cm"> 821  * CONTEXT:</span>
</span><span class='line'><span class="cm"> 822  * spin_lock_irq(rq-&gt;lock)</span>
</span><span class='line'><span class="cm"> 823  */</span>
</span><span class='line'> <span class="mi">824</span> <span class="kt">void</span> <span class="n">wq_worker_waking_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
</span><span class='line'> <span class="mi">825</span> <span class="p">{</span>
</span><span class='line'> <span class="mi">826</span>         <span class="k">struct</span> <span class="n">worker</span> <span class="o">*</span><span class="n">worker</span> <span class="o">=</span> <span class="n">kthread_data</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
</span><span class='line'> <span class="mi">827</span>
</span><span class='line'> <span class="mi">828</span>         <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">worker</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WORKER_NOT_RUNNING</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'> <span class="mi">829</span>                 <span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">worker</span><span class="o">-&gt;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">!=</span> <span class="n">cpu</span><span class="p">);</span>
</span><span class='line'> <span class="mi">830</span>                 <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">worker</span><span class="o">-&gt;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">nr_running</span><span class="p">);</span>
</span><span class='line'> <span class="mi">831</span>         <span class="p">}</span>
</span><span class='line'> <span class="mi">832</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="mi">923</span> <span class="cm">/**</span>
</span><span class='line'><span class="cm"> 924  * worker_clr_flags - clear worker flags and adjust nr_running accordingly</span>
</span><span class='line'><span class="cm"> 925  * @worker: self</span>
</span><span class='line'><span class="cm"> 926  * @flags: flags to clear</span>
</span><span class='line'><span class="cm"> 927  *</span>
</span><span class='line'><span class="cm"> 928  * Clear @flags in @worker-&gt;flags and adjust nr_running accordingly.</span>
</span><span class='line'><span class="cm"> 929  *</span>
</span><span class='line'><span class="cm"> 930  * CONTEXT:</span>
</span><span class='line'><span class="cm"> 931  * spin_lock_irq(pool-&gt;lock)</span>
</span><span class='line'><span class="cm"> 932  */</span>
</span><span class='line'> <span class="mi">933</span> <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">worker_clr_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">worker</span> <span class="o">*</span><span class="n">worker</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span><span class='line'> <span class="mi">934</span> <span class="p">{</span>
</span><span class='line'> <span class="mi">935</span>         <span class="k">struct</span> <span class="n">worker_pool</span> <span class="o">*</span><span class="n">pool</span> <span class="o">=</span> <span class="n">worker</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">;</span>
</span><span class='line'> <span class="mi">936</span>         <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oflags</span> <span class="o">=</span> <span class="n">worker</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
</span><span class='line'> <span class="mi">937</span>
</span><span class='line'> <span class="mi">938</span>         <span class="nf">WARN_ON_ONCE</span><span class="p">(</span><span class="n">worker</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">!=</span> <span class="n">current</span><span class="p">);</span>
</span><span class='line'> <span class="mi">939</span>
</span><span class='line'> <span class="mi">940</span>         <span class="n">worker</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">flags</span><span class="p">;</span>
</span><span class='line'> <span class="mi">941</span>
</span><span class='line'> <span class="mi">942</span>         <span class="cm">/*</span>
</span><span class='line'><span class="cm"> 943          * If transitioning out of NOT_RUNNING, increment nr_running.  Note</span>
</span><span class='line'><span class="cm"> 944          * that the nested NOT_RUNNING is not a noop.  NOT_RUNNING is mask</span>
</span><span class='line'><span class="cm"> 945          * of multiple flags, not a single flag.</span>
</span><span class='line'><span class="cm"> 946          */</span>
</span><span class='line'> <span class="mi">947</span>         <span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WORKER_NOT_RUNNING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">oflags</span> <span class="o">&amp;</span> <span class="n">WORKER_NOT_RUNNING</span><span class="p">))</span>
</span><span class='line'> <span class="mi">948</span>                 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">worker</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WORKER_NOT_RUNNING</span><span class="p">))</span>
</span><span class='line'> <span class="mi">949</span>                         <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">nr_running</span><span class="p">);</span>
</span><span class='line'> <span class="mi">950</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Decrease</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="mi">885</span> <span class="cm">/**</span>
</span><span class='line'><span class="cm"> 886  * worker_set_flags - set worker flags and adjust nr_running accordingly</span>
</span><span class='line'><span class="cm"> 887  * @worker: self</span>
</span><span class='line'><span class="cm"> 888  * @flags: flags to set</span>
</span><span class='line'><span class="cm"> 889  * @wakeup: wakeup an idle worker if necessary</span>
</span><span class='line'><span class="cm"> 890  *</span>
</span><span class='line'><span class="cm"> 891  * Set @flags in @worker-&gt;flags and adjust nr_running accordingly.  If</span>
</span><span class='line'><span class="cm"> 892  * nr_running becomes zero and @wakeup is %true, an idle worker is</span>
</span><span class='line'><span class="cm"> 893  * woken up.</span>
</span><span class='line'><span class="cm"> 894  *</span>
</span><span class='line'><span class="cm"> 895  * CONTEXT:</span>
</span><span class='line'><span class="cm"> 896  * spin_lock_irq(pool-&gt;lock)</span>
</span><span class='line'><span class="cm"> 897  */</span>
</span><span class='line'> <span class="mi">898</span> <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">worker_set_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">worker</span> <span class="o">*</span><span class="n">worker</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
</span><span class='line'> <span class="mi">899</span>                                     <span class="kt">bool</span> <span class="n">wakeup</span><span class="p">)</span>
</span><span class='line'> <span class="mi">900</span> <span class="p">{</span>
</span><span class='line'> <span class="mi">901</span>         <span class="k">struct</span> <span class="n">worker_pool</span> <span class="o">*</span><span class="n">pool</span> <span class="o">=</span> <span class="n">worker</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">;</span>
</span><span class='line'> <span class="mi">902</span>
</span><span class='line'> <span class="mi">903</span>         <span class="nf">WARN_ON_ONCE</span><span class="p">(</span><span class="n">worker</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">!=</span> <span class="n">current</span><span class="p">);</span>
</span><span class='line'> <span class="mi">904</span>
</span><span class='line'> <span class="mi">905</span>         <span class="cm">/*</span>
</span><span class='line'><span class="cm"> 906          * If transitioning into NOT_RUNNING, adjust nr_running and</span>
</span><span class='line'><span class="cm"> 907          * wake up an idle worker as necessary if requested by</span>
</span><span class='line'><span class="cm"> 908          * @wakeup.</span>
</span><span class='line'><span class="cm"> 909          */</span>
</span><span class='line'> <span class="mi">910</span>         <span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WORKER_NOT_RUNNING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'> <span class="mi">911</span>             <span class="o">!</span><span class="p">(</span><span class="n">worker</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WORKER_NOT_RUNNING</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'> <span class="mi">912</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">wakeup</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'> <span class="mi">913</span>                         <span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">nr_running</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'> <span class="mi">914</span>                             <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">worklist</span><span class="p">))</span>
</span><span class='line'> <span class="mi">915</span>                                 <span class="n">wake_up_worker</span><span class="p">(</span><span class="n">pool</span><span class="p">);</span>
</span><span class='line'> <span class="mi">916</span>                 <span class="p">}</span> <span class="k">else</span>
</span><span class='line'> <span class="mi">917</span>                         <span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">nr_running</span><span class="p">);</span>
</span><span class='line'> <span class="mi">918</span>         <span class="p">}</span>
</span><span class='line'> <span class="mi">919</span>
</span><span class='line'> <span class="mi">920</span>         <span class="n">worker</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">flags</span><span class="p">;</span>
</span><span class='line'> <span class="mi">921</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="mi">834</span> <span class="cm">/**</span>
</span><span class='line'><span class="cm"> 835  * wq_worker_sleeping - a worker is going to sleep</span>
</span><span class='line'><span class="cm"> 836  * @task: task going to sleep</span>
</span><span class='line'><span class="cm"> 837  * @cpu: CPU in question, must be the current CPU number</span>
</span><span class='line'><span class="cm"> 838  *</span>
</span><span class='line'><span class="cm"> 839  * This function is called during schedule() when a busy worker is</span>
</span><span class='line'><span class="cm"> 840  * going to sleep.  Worker on the same cpu can be woken up by</span>
</span><span class='line'><span class="cm"> 841  * returning pointer to its task.</span>
</span><span class='line'><span class="cm"> 842  *</span>
</span><span class='line'><span class="cm"> 843  * CONTEXT:</span>
</span><span class='line'><span class="cm"> 844  * spin_lock_irq(rq-&gt;lock)</span>
</span><span class='line'><span class="cm"> 845  *</span>
</span><span class='line'><span class="cm"> 846  * Return:</span>
</span><span class='line'><span class="cm"> 847  * Worker task on @cpu to wake up, %NULL if none.</span>
</span><span class='line'><span class="cm"> 848  */</span>
</span><span class='line'> <span class="mi">849</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">wq_worker_sleeping</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
</span><span class='line'> <span class="mi">850</span> <span class="p">{</span>
</span><span class='line'> <span class="mi">851</span>         <span class="k">struct</span> <span class="n">worker</span> <span class="o">*</span><span class="n">worker</span> <span class="o">=</span> <span class="n">kthread_data</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="o">*</span><span class="n">to_wakeup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'> <span class="mi">852</span>         <span class="k">struct</span> <span class="n">worker_pool</span> <span class="o">*</span><span class="n">pool</span><span class="p">;</span>
</span><span class='line'> <span class="mi">853</span>
</span><span class='line'> <span class="mi">854</span>         <span class="cm">/*</span>
</span><span class='line'><span class="cm"> 855          * Rescuers, which may not have all the fields set up like normal</span>
</span><span class='line'><span class="cm"> 856          * workers, also reach here, let&#39;s not access anything before</span>
</span><span class='line'><span class="cm"> 857          * checking NOT_RUNNING.</span>
</span><span class='line'><span class="cm"> 858          */</span>
</span><span class='line'> <span class="mi">859</span>         <span class="k">if</span> <span class="p">(</span><span class="n">worker</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WORKER_NOT_RUNNING</span><span class="p">)</span>
</span><span class='line'> <span class="mi">860</span>                 <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'> <span class="mi">861</span>
</span><span class='line'> <span class="mi">862</span>         <span class="n">pool</span> <span class="o">=</span> <span class="n">worker</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">;</span>
</span><span class='line'> <span class="mi">863</span>
</span><span class='line'> <span class="mi">864</span>         <span class="cm">/* this can only happen on the local cpu */</span>
</span><span class='line'> <span class="mi">865</span>         <span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">cpu</span> <span class="o">!=</span> <span class="n">raw_smp_processor_id</span><span class="p">()))</span>
</span><span class='line'> <span class="mi">866</span>                 <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'> <span class="mi">867</span>
</span><span class='line'> <span class="mi">868</span>         <span class="cm">/*</span>
</span><span class='line'><span class="cm"> 869          * The counterpart of the following dec_and_test, implied mb,</span>
</span><span class='line'><span class="cm"> 870          * worklist not empty test sequence is in insert_work().</span>
</span><span class='line'><span class="cm"> 871          * Please read comment there.</span>
</span><span class='line'><span class="cm"> 872          *</span>
</span><span class='line'><span class="cm"> 873          * NOT_RUNNING is clear.  This means that we&#39;re bound to and</span>
</span><span class='line'><span class="cm"> 874          * running on the local cpu w/ rq lock held and preemption</span>
</span><span class='line'><span class="cm"> 875          * disabled, which in turn means that none else could be</span>
</span><span class='line'><span class="cm"> 876          * manipulating idle_list, so dereferencing idle_list without pool</span>
</span><span class='line'><span class="cm"> 877          * lock is safe.</span>
</span><span class='line'><span class="cm"> 878          */</span>
</span><span class='line'> <span class="mi">879</span>         <span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">nr_running</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'> <span class="mi">880</span>             <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">worklist</span><span class="p">))</span>
</span><span class='line'> <span class="mi">881</span>                 <span class="n">to_wakeup</span> <span class="o">=</span> <span class="n">first_worker</span><span class="p">(</span><span class="n">pool</span><span class="p">);</span>
</span><span class='line'> <span class="mi">882</span>         <span class="k">return</span> <span class="n">to_wakeup</span> <span class="o">?</span> <span class="n">to_wakeup</span><span class="o">-&gt;</span><span class="nl">task</span> <span class="p">:</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'> <span class="mi">883</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/21/ftrace-study/">Ftrace Study</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/17/netdevice-watchdog-cause-tx-queue-schedule/">Netdevice Watchdog Cause Tx Queue Schedule</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/16/ixgbe-queue-index/">How Does Ixgbe Use Queue Index</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/14/tcpdump-work-with-bonding-interface/">Tcpdump Work With Bonding Interface</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/31/how-to-select-source-ip-for-a-tcp-socket/">How to Select Source Ip for a Tcp Socket</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/martinbj2008@gmail.com">@martinbj2008@gmail.com</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'martinbj2008@gmail.com',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Your Name -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
