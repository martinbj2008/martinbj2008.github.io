
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Where Softirq Is Invoked - My Octopress Blog</title>
  <meta name="author" content="Your Name">

  
  <meta name="description" content="summary softirq 真正干活的函数是__do_softirq。
linuxv3.11内核里能够执行__do_softirq,有如下调用,
这里指真正执行softirq的地方，不是触发(设置)softirq标志 !!! 每个硬中断退出的时。
当bh使能的时。
发送回环报文时。 case1 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://martinbj2008.github.io/blog/2013/09/23/where-softirq-is-invoked/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!-- link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css" -->
<!-- link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css" -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="martinbj2008.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Where Softirq Is Invoked</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-09-23T10:36:00+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2013</span></span> <span class='time'>10:36 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>summary</h2>

<p>softirq 真正干活的函数是<code>__do_softirq</code>。
linuxv3.11内核里能够执行<code>__do_softirq</code>,有如下调用,
这里指真正执行softirq的地方，不是触发(设置)softirq标志 !!!</p>

<ol>
<li>每个硬中断退出的时。</li>
<li>当bh使能的时。</li>
<li>发送回环报文时。</li>
</ol>


<!-- more -->


<h3>case1 每个硬中断退出的时候。</h3>

<h4>call trace</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">&gt;</span> <span class="n">irq_exit</span>
</span><span class='line'><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">invoke_softirq</span>
</span><span class='line'><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">__do_softirq</span>
</span></code></pre></td></tr></table></div></figure>


<h4><code>irq_exit</code></h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mi">350</span> <span class="cm">/*</span>
</span><span class='line'><span class="cm">351  * Exit an interrupt context. Process softirqs if needed and possible:</span>
</span><span class='line'><span class="cm">352  */</span>
</span><span class='line'><span class="mi">353</span> <span class="kt">void</span> <span class="n">irq_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="mi">354</span> <span class="p">{</span>
</span><span class='line'><span class="mi">355</span> <span class="err">#</span><span class="n">ifndef</span> <span class="n">__ARCH_IRQ_EXIT_IRQS_DISABLED</span>
</span><span class='line'><span class="mi">356</span>         <span class="n">local_irq_disable</span><span class="p">();</span>
</span><span class='line'><span class="mi">357</span> <span class="err">#</span><span class="k">else</span>
</span><span class='line'><span class="mi">358</span>         <span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">());</span>
</span><span class='line'><span class="mi">359</span> <span class="err">#</span><span class="n">endif</span>
</span><span class='line'><span class="mi">360</span>
</span><span class='line'><span class="mi">361</span>         <span class="n">account_irq_exit_time</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
</span><span class='line'><span class="mi">362</span>         <span class="nf">trace_hardirq_exit</span><span class="p">();</span>
</span><span class='line'><span class="mi">363</span>         <span class="nf">sub_preempt_count</span><span class="p">(</span><span class="n">HARDIRQ_OFFSET</span><span class="p">);</span>
</span><span class='line'><span class="mi">364</span>         <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">local_softirq_pending</span><span class="p">())</span>
</span><span class='line'><span class="mi">365</span>                 <span class="n">invoke_softirq</span><span class="p">();</span>
</span><span class='line'><span class="mi">366</span>
</span><span class='line'><span class="mi">367</span>         <span class="nf">tick_irq_exit</span><span class="p">();</span>
</span><span class='line'><span class="mi">368</span>         <span class="nf">rcu_irq_exit</span><span class="p">();</span>
</span><span class='line'><span class="mi">369</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4><code>invoke_softirq</code></h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mi">329</span> <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">invoke_softirq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="mi">330</span> <span class="p">{</span>
</span><span class='line'><span class="mi">331</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force_irqthreads</span><span class="p">)</span>
</span><span class='line'><span class="mi">332</span>                 <span class="n">__do_softirq</span><span class="p">();</span>
</span><span class='line'><span class="mi">333</span>         <span class="k">else</span>
</span><span class='line'><span class="mi">334</span>                 <span class="nf">wakeup_softirqd</span><span class="p">();</span>
</span><span class='line'><span class="mi">335</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>case2 使能bh的时候</h3>

<h4>call trace</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">&gt;</span> <span class="n">local_bh_enable</span>
</span><span class='line'><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">_local_bh_enable_ip</span>
</span><span class='line'><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">do_softirq</span>
</span><span class='line'><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">x86_64</span><span class="err">特有的</span><span class="p">)</span><span class="n">call_softirq</span>
</span><span class='line'><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">__do_softirq</span>
</span></code></pre></td></tr></table></div></figure>


<h4><code>local_bh_enable</code></h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mi">184</span> <span class="kt">void</span> <span class="nf">local_bh_enable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="mi">185</span> <span class="p">{</span>
</span><span class='line'><span class="mi">186</span>         <span class="n">_local_bh_enable_ip</span><span class="p">(</span><span class="n">_RET_IP_</span><span class="p">);</span>
</span><span class='line'><span class="mi">187</span> <span class="p">}</span>
</span><span class='line'><span class="mi">188</span> <span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">local_bh_enable</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4><code>_local_bh_enable_ip</code></h4>

<p>NOTE: 使能bh的时候，刚开始抢占还是禁止的。只有软中断处理完了后，抢占才使能的。
顺便说一下，使能bh时，有可能发生进程切换(见<code>preempt_check_resched</code>).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mi">157</span> <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_local_bh_enable_ip</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span><span class="p">)</span>
</span><span class='line'><span class="mi">158</span> <span class="p">{</span>
</span><span class='line'><span class="mi">159</span>         <span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">in_irq</span><span class="p">()</span> <span class="o">||</span> <span class="n">irqs_disabled</span><span class="p">());</span>
</span><span class='line'><span class="mi">160</span> <span class="err">#</span><span class="n">ifdef</span> <span class="n">CONFIG_TRACE_IRQFLAGS</span>
</span><span class='line'><span class="mi">161</span>         <span class="n">local_irq_disable</span><span class="p">();</span>
</span><span class='line'><span class="mi">162</span> <span class="err">#</span><span class="n">endif</span>
</span><span class='line'><span class="mi">163</span>         <span class="cm">/*</span>
</span><span class='line'><span class="cm">164          * Are softirqs going to be turned on now:</span>
</span><span class='line'><span class="cm">165          */</span>
</span><span class='line'><span class="mi">166</span>         <span class="k">if</span> <span class="p">(</span><span class="n">softirq_count</span><span class="p">()</span> <span class="o">==</span> <span class="n">SOFTIRQ_DISABLE_OFFSET</span><span class="p">)</span>
</span><span class='line'><span class="mi">167</span>                 <span class="n">trace_softirqs_on</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
</span><span class='line'><span class="mi">168</span>         <span class="cm">/*</span>
</span><span class='line'><span class="cm">169          * Keep preemption disabled until we are done with</span>
</span><span class='line'><span class="cm">170          * softirq processing:</span>
</span><span class='line'><span class="cm">171          */</span>
</span><span class='line'><span class="mi">172</span>         <span class="n">sub_preempt_count</span><span class="p">(</span><span class="n">SOFTIRQ_DISABLE_OFFSET</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="mi">173</span>
</span><span class='line'><span class="mi">174</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">local_softirq_pending</span><span class="p">()))</span>
</span><span class='line'><span class="mi">175</span>                 <span class="n">do_softirq</span><span class="p">();</span>
</span><span class='line'><span class="mi">176</span>
</span><span class='line'><span class="mi">177</span>         <span class="nf">dec_preempt_count</span><span class="p">();</span>
</span><span class='line'><span class="mi">178</span> <span class="err">#</span><span class="n">ifdef</span> <span class="n">CONFIG_TRACE_IRQFLAGS</span>
</span><span class='line'><span class="mi">179</span>         <span class="n">local_irq_enable</span><span class="p">();</span>
</span><span class='line'><span class="mi">180</span> <span class="err">#</span><span class="n">endif</span>
</span><span class='line'><span class="mi">181</span>         <span class="n">preempt_check_resched</span><span class="p">();</span>
</span><span class='line'><span class="mi">182</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4><code>do_softirq</code>根据不同的体系机构有不同的版本。</h4>

<p>当对应的硬件体系里没有定义<code>do_softirq</code>时，使用
<code>kernel/softirq.c</code>中通用的do_softirq`.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mi">286</span> <span class="err">#</span><span class="n">ifndef</span> <span class="n">__ARCH_HAS_DO_SOFTIRQ</span>
</span><span class='line'><span class="mi">287</span>
</span><span class='line'><span class="mi">288</span> <span class="n">asmlinkage</span> <span class="kt">void</span> <span class="n">do_softirq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="mi">289</span> <span class="p">{</span>
</span><span class='line'><span class="mi">290</span>         <span class="n">__u32</span> <span class="n">pending</span><span class="p">;</span>
</span><span class='line'><span class="mi">291</span>         <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
</span><span class='line'><span class="mi">292</span>
</span><span class='line'><span class="mi">293</span>         <span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span>
</span><span class='line'><span class="mi">294</span>                 <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="mi">295</span>
</span><span class='line'><span class="mi">296</span>         <span class="nf">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
</span><span class='line'><span class="mi">297</span>
</span><span class='line'><span class="mi">298</span>         <span class="n">pending</span> <span class="o">=</span> <span class="n">local_softirq_pending</span><span class="p">();</span>
</span><span class='line'><span class="mi">299</span>
</span><span class='line'><span class="mi">300</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">pending</span><span class="p">)</span>
</span><span class='line'><span class="mi">301</span>                 <span class="n">__do_softirq</span><span class="p">();</span>
</span><span class='line'><span class="mi">302</span>
</span><span class='line'><span class="mi">303</span>         <span class="nf">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
</span><span class='line'><span class="mi">304</span> <span class="p">}</span>
</span><span class='line'><span class="mi">305</span>
</span><span class='line'><span class="mi">306</span> <span class="err">#</span><span class="n">endif</span>
</span></code></pre></td></tr></table></div></figure>


<p>而对于X86_64,有其自己的定义。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="mi">92</span> <span class="k">extern</span> <span class="kt">void</span> <span class="nf">call_softirq</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'> <span class="mi">93</span>
</span><span class='line'> <span class="mi">94</span> <span class="n">asmlinkage</span> <span class="kt">void</span> <span class="n">do_softirq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'> <span class="mi">95</span> <span class="p">{</span>
</span><span class='line'> <span class="mi">96</span>         <span class="n">__u32</span> <span class="n">pending</span><span class="p">;</span>
</span><span class='line'> <span class="mi">97</span>         <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
</span><span class='line'> <span class="mi">98</span>
</span><span class='line'> <span class="mi">99</span>         <span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span>
</span><span class='line'><span class="mi">100</span>                 <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="mi">101</span>
</span><span class='line'><span class="mi">102</span>         <span class="nf">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
</span><span class='line'><span class="mi">103</span>         <span class="n">pending</span> <span class="o">=</span> <span class="n">local_softirq_pending</span><span class="p">();</span>
</span><span class='line'><span class="mi">104</span>         <span class="cm">/* Switch to interrupt stack */</span>
</span><span class='line'><span class="mi">105</span>         <span class="k">if</span> <span class="p">(</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="mi">106</span>                 <span class="n">call_softirq</span><span class="p">();</span>
</span><span class='line'><span class="mi">107</span>                 <span class="nf">WARN_ON_ONCE</span><span class="p">(</span><span class="n">softirq_count</span><span class="p">());</span>
</span><span class='line'><span class="mi">108</span>         <span class="p">}</span>
</span><span class='line'><span class="mi">109</span>         <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
</span><span class='line'><span class="mi">110</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中<code>call_softirq</code>是个用汇编语言写的一个函数定义在 arch/x86/kernel/entry_64.S</p>

<h3><code>netif_rx_ni</code></h3>

<p>这一块的理解不是很透，仅以一个具体的例子来说明。<code>发送回环报文</code>.</p>

<h4>发送回环报文</h4>

<h4>call trace</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">&gt;</span> <span class="n">dev_loopback_xmit</span>
</span><span class='line'><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">netif_rx_ni</span>
</span><span class='line'><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">do_softirq</span>
</span><span class='line'><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">__do_softirq</span>
</span></code></pre></td></tr></table></div></figure>


<p>loopback 报文会通过<code>netif_rx</code>函数，被重新放回到
per_cpu变量<code>softnet_data</code>下的队列<code>input_pkt_queue</code>里，
同时激发napi调用，进而激发软中断调用(只是设置标志位，不是真正调用）</p>

<p>另外，注意<code>netif_rx_ni</code>里没有禁止bh调度，而是只是禁止了抢占(<code>preempt_disable</code>).</p>

<h5><code>dev_loopback_xmit</code></h5>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mi">2765</span> <span class="kt">int</span> <span class="nf">dev_loopback_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
</span><span class='line'><span class="mi">2766</span> <span class="p">{</span>
</span><span class='line'><span class="mi">2767</span>         <span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span><span class='line'><span class="mi">2768</span>         <span class="nf">__skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
</span><span class='line'><span class="mi">2769</span>         <span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_LOOPBACK</span><span class="p">;</span>
</span><span class='line'><span class="mi">2770</span>         <span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
</span><span class='line'><span class="mi">2771</span>         <span class="nf">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
</span><span class='line'><span class="mi">2772</span>         <span class="nf">skb_dst_force</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span><span class='line'><span class="mi">2773</span>         <span class="nf">netif_rx_ni</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span><span class='line'><span class="mi">2774</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="mi">2775</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h5><code>netif_rx_ni</code></h5>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mi">3267</span> <span class="kt">int</span> <span class="n">netif_rx_ni</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
</span><span class='line'><span class="mi">3268</span> <span class="p">{</span>
</span><span class='line'><span class="mi">3269</span>         <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span><span class='line'><span class="mi">3270</span>
</span><span class='line'><span class="mi">3271</span>         <span class="nf">preempt_disable</span><span class="p">();</span>
</span><span class='line'><span class="mi">3272</span>         <span class="n">err</span> <span class="o">=</span> <span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span><span class='line'><span class="mi">3273</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">local_softirq_pending</span><span class="p">())</span>
</span><span class='line'><span class="mi">3274</span>                 <span class="n">do_softirq</span><span class="p">();</span>
</span><span class='line'><span class="mi">3275</span>         <span class="nf">preempt_enable</span><span class="p">();</span>
</span><span class='line'><span class="mi">3276</span>
</span><span class='line'><span class="mi">3277</span>         <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span><span class='line'><span class="mi">3278</span> <span class="p">}</span>
</span><span class='line'><span class="mi">3279</span> <span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">netif_rx_ni</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Your Name</span></span>

      




<time class='entry-date' datetime='2013-09-23T10:36:00+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2013</span></span> <span class='time'>10:36 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/irqs/'>irqs</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/09/12/ipv4-route-fib-insert-node/" title="Previous Post: IPv4 route fib insert node">&laquo; IPv4 route fib insert node</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/09/27/ipv4-route-fib-tree-rebalance/" title="Next Post: IPv4 route fib tree rebalance">IPv4 route fib tree rebalance &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/21/ftrace-study/">Ftrace Study</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/17/netdevice-watchdog-cause-tx-queue-schedule/">Netdevice Watchdog Cause Tx Queue Schedule</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/16/ixgbe-queue-index/">How Does Ixgbe Use Queue Index</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/14/tcpdump-work-with-bonding-interface/">Tcpdump Work With Bonding Interface</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/31/how-to-select-source-ip-for-a-tcp-socket/">How to Select Source Ip for a Tcp Socket</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/martinbj2008@gmail.com">@martinbj2008@gmail.com</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'martinbj2008@gmail.com',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Your Name -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
