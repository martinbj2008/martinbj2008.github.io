
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Add a Ip Address on a Interface(todo) - My Octopress Blog</title>
  <meta name="author" content="Your Name">

  
  <meta name="description" content="summary When a ip addr is added, two unicat route entries are added to route table. a host route entry is added to local table.
The packet to local &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://martinbj2008.github.io/blog/2012/08/29/add-a-ip-address-on-a-interface/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!-- link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css" -->
<!-- link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css" -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="martinbj2008.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Add a Ip Address on a Interface(todo)</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2012-08-29T00:00:00+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2012</span></span> <span class='time'>12:00 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>summary</h2>

<p>When a ip addr is added, two unicat route entries are added to route table.</p>

<ol>
<li>a host route entry is added to local table.
The packet to local host will be routed by this route entry. The route still is valid, even the related interface is shut down.</li>
<li>a connected route is added to main table.
It is used to forward the packet to the hosts in the same sub network, it will disappear when interface down</li>
<li>two broad cast routes entry also added.</li>
</ol>


<!-- more -->


<h2>broadcast route:</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~ # dmesg  -c
</span><span class='line'>~ # ifconfig 
</span><span class='line'>~ # ip link
</span><span class='line'>1: lo: &lt;LOOPBACK&gt; mtu 16436 qdisc noop state DOWN mode DEFAULT 
</span><span class='line'>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span class='line'>2: dummy0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT 
</span><span class='line'>    link/ether 16:83:71:72:da:97 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>3: eth0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
</span><span class='line'>    link/ether 08:00:27:89:78:8f brd ff:ff:ff:ff:ff:ff
</span><span class='line'>4: eth1: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
</span><span class='line'>    link/ether 08:00:27:eb:21:53 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>5: eth2: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
</span><span class='line'>    link/ether 08:00:27:2a:3f:e3 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>6: teql0: &lt;NOARP&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 100
</span><span class='line'>    link/void 
</span><span class='line'>7: tunl0: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN mode DEFAULT 
</span><span class='line'>    link/ipip 0.0.0.0 brd 0.0.0.0
</span><span class='line'>8: sit0: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN mode DEFAULT 
</span><span class='line'>    link/sit 0.0.0.0 brd 0.0.0.0
</span><span class='line'>9: ip6tnl0: &lt;NOARP&gt; mtu 1452 qdisc noop state DOWN mode DEFAULT 
</span><span class='line'>    link/tunnel6 :: brd ::</span></code></pre></td></tr></table></div></figure>


<h3>ip link set eth1 up</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~ # ip link set dev eth1 up
</span><span class='line'>~ # dmesg  -c
</span><span class='line'>IPv6: ADDRCONF(NETDEV_UP): eth1: link is not ready
</span><span class='line'>e1000: eth1 NIC Link is Up 1000 Mbps Full Duplex, Flow Control: RX
</span><span class='line'>IPv6: ADDRCONF(NETDEV_CHANGE): eth1: link becomes ready
</span><span class='line'>~ # </span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~ # ip route show table local
</span><span class='line'>~ # ip route show table main
</span><span class='line'>~ # dmesg  -c
</span><span class='line'>~ # 
</span><span class='line'>~ # ip addr add dev eth1 10.80.2.72/24    &lt;=== configure a ip address on a interface.
</span><span class='line'>~ # 
</span><span class='line'>~ # dmesg -c &lt;=== the related call trace.
</span><span class='line'>inet_rtm_newaddr: is called
</span><span class='line'>__inet_insert_ifa:  ifa=ffff88003d1fa7e0, ifa_address:4802500a
</span><span class='line'>     ifa_local=4802500a,       ifa_mask=00ffffff
</span><span class='line'>__inet_insert_ifa:  send rtm msg for ifa=ffff88003d1fa7e0
</span><span class='line'>fib_inetaddr_event: event=00000001
</span><span class='line'>fib_add_ifaddr: call fib_magic RTM_NEWROUTE, RTN_LOCAL with addr=4802500a
</span><span class='line'>fib_magic: type=2, dst=4802500a, dst_len=32
</span><span class='line'>fib_add_ifaddr: call fib_magic RTM_NEWROUTE, with frefixlen
</span><span class='line'>fib_magic: type=1, dst=0002500a, dst_len=24
</span><span class='line'>fib_add_ifaddr: call fib_magic RTM_NEWROUTE, to add two broadcast route
</span><span class='line'>fib_magic: type=3, dst=0002500a, dst_len=32
</span><span class='line'>fib_magic: type=3, dst=ff02500a, dst_len=32</span></code></pre></td></tr></table></div></figure>


<h3>two broadcast routes are added.</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~ # ip route list table local    &lt;=== two broadcast routes are added to local, a host route(ip_local_in) is added also.
</span><span class='line'>broadcast 10.80.2.0 dev eth1  proto kernel  scope link  src 10.80.2.72 
</span><span class='line'>local 10.80.2.72 dev eth1  proto kernel  scope host  src 10.80.2.72 
</span><span class='line'>broadcast 10.80.2.255 dev eth1  proto kernel  scope link  src 10.80.2.72 
</span><span class='line'>a connected route is added.</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~ # ip route list table main     &lt;=== 
</span><span class='line'>10.80.2.0/24 dev eth1  proto kernel  scope link  src 10.80.2.72    &lt;=== it will be delete if interface down, while local route will not  be deleted.
</span><span class='line'>set eth1 down,</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~ # ip link set dev eth1 down
</span><span class='line'>~ # ip route show table main &lt;== nothing remain.
</span><span class='line'>~ # ip route show table local
</span><span class='line'>local 10.80.2.72 dev eth1  proto kernel  scope host  src 10.80.2.72  &lt;== still there
</span><span class='line'>ping localhost ip address with lo up</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~ # ip link set dev lo up &lt;== MUST confirm lo up.
</span><span class='line'>~ # ping  -c 3 10.80.2.72  &lt;== ping itself OK.
</span><span class='line'>PING 10.80.2.72 (10.80.2.72): 56 data bytes
</span><span class='line'>64 bytes from 10.80.2.72: seq=0 ttl=64 time=0.068 ms
</span><span class='line'>64 bytes from 10.80.2.72: seq=1 ttl=64 time=0.069 ms
</span><span class='line'>64 bytes from 10.80.2.72: seq=2 ttl=64 time=0.088 ms
</span><span class='line'>
</span><span class='line'>--- 10.80.2.72 ping statistics ---
</span><span class='line'>3 packets transmitted, 3 packets received, 0% packet loss
</span><span class='line'>round-trip min/avg/max = 0.068/0.075/0.088 ms
</span><span class='line'>~ # </span></code></pre></td></tr></table></div></figure>


<h3>related source:</h3>

<p>in net/ipv4/devinet.c, register_inetaddr_notifier</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mi">178</span> <span class="k">static</span> <span class="nf">BLOCKING_NOTIFIER_HEAD</span><span class="p">(</span><span class="n">inetaddr_chain</span><span class="p">);</span>
</span><span class='line'><span class="mi">1091</span> <span class="kt">int</span> <span class="n">register_inetaddr_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
</span><span class='line'><span class="n">net</span><span class="o">/</span><span class="n">ipv4</span><span class="o">/</span><span class="n">fib_frontend</span><span class="p">.</span><span class="n">c</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mi">1190</span>         <span class="nf">register_inetaddr_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fib_inetaddr_notifier</span><span class="p">);</span>
</span><span class='line'><span class="mi">1089</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">fib_inetaddr_notifier</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'><span class="mi">1090</span>         <span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">fib_inetaddr_event</span><span class="p">,</span>
</span><span class='line'><span class="mi">1091</span> <span class="p">};</span>
</span><span class='line'><span class="mi">737</span> <span class="kt">void</span> <span class="n">fib_add_ifaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>add a hostroute</li>
<li>add connect route</li>
<li>add two broadcast for network_address.255|0</li>
</ol>


<p>net/ipv4/fib_frontend.c</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mi">698</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">fib_magic</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Your Name</span></span>

      




<time class='entry-date' datetime='2012-08-29T00:00:00+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2012</span></span> <span class='time'>12:00 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/netcore/'>netcore</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/08/16/x86_64-memory-map/" title="Previous Post: x86_64 Memory Map When Boot">&laquo; x86_64 Memory Map When Boot</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/11/10/add-update-xfrm-polciy/" title="Next Post: Add or Udpate Xfrm Policy">Add or Udpate Xfrm Policy &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/21/ftrace-study/">Ftrace Study</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/17/netdevice-watchdog-cause-tx-queue-schedule/">Netdevice Watchdog Cause Tx Queue Schedule</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/16/ixgbe-queue-index/">How Does Ixgbe Use Queue Index</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/14/tcpdump-work-with-bonding-interface/">Tcpdump Work With Bonding Interface</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/31/how-to-select-source-ip-for-a-tcp-socket/">How to Select Source Ip for a Tcp Socket</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/martinbj2008@gmail.com">@martinbj2008@gmail.com</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'martinbj2008@gmail.com',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Your Name -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
